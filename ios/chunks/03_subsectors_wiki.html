<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0f1a">
  <title>MOAT Analyzer</title>

  <script type="module">
    import { h, render } from 'https://esm.sh/preact@10.19.3';
    import { useState, useEffect, useMemo, useCallback, useRef } from 'https://esm.sh/preact@10.19.3/hooks';
    import htm from 'https://esm.sh/htm@3.1.1';
    const html = htm.bind(h);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONSTANTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const C = {
      bg: "#0a0f1a", cardBg: "#111827", bgAlt: "#1a2332",
      copy: "#e2e8f0", text: "#e2e8f0", dim: "#8899aa", border: "#1e2d3d",
      accent: "#4da3ff", ww1: "#326295", primary: "#326295",
      green: "#43b02a", greenLt: "#b3d57d",
      yellow: "#ede04b", orange: "#f39c12", red: "#e74c3c",
      grayMid: "#97999b", purple: "#a855f7", cyan: "#06b6d4",
    };

    const TIER_COLORS = {
      CRITICAL: C.red, HIGH: C.orange, MEDIUM: C.yellow,
      "LOW-MEDIUM": C.greenLt, LOW: C.green,
    };

    const MOAT_LABELS = {
      sc: "Switching Costs", ne: "Network Effects",
      ia: "Intangible Assets", ca: "Cost Advantage", es: "Efficient Scale",
    };

    const AI_LABELS = {
      ls: "Labor Substitution", vcd: "Value Chain Disruption",
      dme: "Data/Model Edge", anc: "Autonomous New Competition",
      cir: "Customer Interaction Risk",
    };

    const SECTOR_DB = {
      "Information Technology":  { sc:4, ne:4, ia:4, ca:3, es:2, ls:3, vcd:2, dme:3, anc:4, cir:3 },
      "Communication Services":  { sc:3, ne:5, ia:4, ca:2, es:3, ls:3, vcd:3, dme:4, anc:3, cir:4 },
      "Health Care":             { sc:3, ne:1, ia:5, ca:2, es:3, ls:2, vcd:2, dme:2, anc:3, cir:2 },
      "Financials":              { sc:3, ne:2, ia:3, ca:3, es:3, ls:5, vcd:4, dme:3, anc:4, cir:4 },
      "Consumer Staples":        { sc:2, ne:1, ia:4, ca:4, es:2, ls:2, vcd:2, dme:1, anc:2, cir:1 },
      "Industrials":             { sc:3, ne:1, ia:3, ca:4, es:3, ls:3, vcd:2, dme:2, anc:2, cir:2 },
      "Consumer Discretionary":  { sc:2, ne:2, ia:3, ca:2, es:1, ls:3, vcd:4, dme:3, anc:3, cir:3 },
      "Energy":                  { sc:1, ne:1, ia:2, ca:4, es:4, ls:1, vcd:1, dme:1, anc:1, cir:1 },
      "Utilities":               { sc:2, ne:1, ia:3, ca:3, es:5, ls:1, vcd:1, dme:1, anc:1, cir:1 },
      "Real Estate":             { sc:2, ne:1, ia:2, ca:2, es:3, ls:3, vcd:4, dme:2, anc:3, cir:3 },
      "Materials":               { sc:1, ne:1, ia:2, ca:4, es:3, ls:2, vcd:1, dme:1, anc:1, cir:1 },
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SUBSECTOR DATABASE (Chunk 3)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const SUBSEC = {
      "Information Technology":[
        {name:"Enterprise Software (SaaS)",sc:5,ne:3,ia:4,ca:2,es:2,ls:4,vcd:3,dme:3,anc:5,cir:4,examples:"CRM, WDAY, NOW"},
        {name:"Semiconductors",sc:3,ne:2,ia:5,ca:5,es:4,ls:1,vcd:1,dme:2,anc:2,cir:1,examples:"NVDA, AMD, INTC"},
        {name:"IT Services / Consulting",sc:3,ne:1,ia:2,ca:2,es:1,ls:5,vcd:4,dme:2,anc:4,cir:5,examples:"ACN, IBM, INFY"},
        {name:"Consumer Internet / Search",sc:4,ne:5,ia:4,ca:4,es:3,ls:2,vcd:2,dme:4,anc:4,cir:3,examples:"GOOGL, META"},
        {name:"Hardware / Devices",sc:4,ne:3,ia:4,ca:3,es:2,ls:1,vcd:1,dme:2,anc:3,cir:2,examples:"AAPL, DELL, HPQ"},
        {name:"Cybersecurity",sc:4,ne:2,ia:4,ca:2,es:2,ls:2,vcd:2,dme:3,anc:4,cir:3,examples:"CRWD, PANW, FTNT"}],
      "Health Care":[
        {name:"Pharma / Biotech",sc:2,ne:1,ia:5,ca:2,es:3,ls:1,vcd:1,dme:1,anc:2,cir:1,examples:"LLY, JNJ, PFE"},
        {name:"Medical Devices",sc:4,ne:1,ia:5,ca:3,es:3,ls:1,vcd:1,dme:1,anc:2,cir:1,examples:"MDT, SYK, ABT"},
        {name:"Health IT / Revenue Cycle",sc:5,ne:2,ia:3,ca:2,es:2,ls:4,vcd:3,dme:3,anc:4,cir:4,examples:"VEEV, HIMS"},
        {name:"Managed Care / Insurance",sc:3,ne:2,ia:3,ca:3,es:4,ls:3,vcd:3,dme:2,anc:3,cir:3,examples:"UNH, ELV, CI"},
        {name:"CRO / Life Sciences Tools",sc:3,ne:1,ia:4,ca:2,es:2,ls:3,vcd:2,dme:2,anc:3,cir:2,examples:"TMO, DHR, ICLR"}],
      "Financials":[
        {name:"Banks (Large/Universal)",sc:4,ne:2,ia:3,ca:3,es:4,ls:4,vcd:3,dme:2,anc:3,cir:3,examples:"JPM, BAC, WFC"},
        {name:"Insurance",sc:3,ne:1,ia:3,ca:3,es:3,ls:4,vcd:3,dme:2,anc:3,cir:3,examples:"BRK, PGR, MET"},
        {name:"Asset Management",sc:2,ne:1,ia:3,ca:2,es:2,ls:3,vcd:4,dme:3,anc:4,cir:4,examples:"BLK, BX, WHG"},
        {name:"Payments / Fintech",sc:4,ne:5,ia:3,ca:3,es:3,ls:3,vcd:4,dme:4,anc:5,cir:4,examples:"V, MA, SQ"},
        {name:"Brokerage / Exchanges",sc:3,ne:4,ia:3,ca:3,es:4,ls:4,vcd:4,dme:3,anc:4,cir:4,examples:"SCHW, ICE, CME"}],
      "Consumer Discretionary":[
        {name:"E-Commerce / Marketplace",sc:3,ne:5,ia:3,ca:3,es:2,ls:2,vcd:4,dme:4,anc:4,cir:3,examples:"AMZN, EBAY, ETSY"},
        {name:"Restaurants / QSR",sc:2,ne:1,ia:4,ca:3,es:2,ls:2,vcd:2,dme:1,anc:1,cir:1,examples:"MCD, SBUX, CMG"},
        {name:"Luxury / Apparel",sc:2,ne:2,ia:5,ca:1,es:1,ls:1,vcd:3,dme:2,anc:2,cir:1,examples:"NKE, LULU, TJX"},
        {name:"Auto / EV",sc:2,ne:1,ia:3,ca:3,es:3,ls:2,vcd:1,dme:1,anc:2,cir:1,examples:"TSLA, GM, F"},
        {name:"Travel / Leisure",sc:2,ne:3,ia:3,ca:2,es:2,ls:3,vcd:5,dme:3,anc:4,cir:3,examples:"BKNG, ABNB, MAR"}],
      "Communication Services":[
        {name:"Social Media / UGC Platforms",sc:4,ne:5,ia:4,ca:2,es:2,ls:2,vcd:2,dme:4,anc:4,cir:3,examples:"META, SNAP, PINS"},
        {name:"Streaming / Media",sc:2,ne:3,ia:4,ca:2,es:3,ls:2,vcd:4,dme:3,anc:3,cir:4,examples:"NFLX, DIS, WBD"},
        {name:"Telecom",sc:3,ne:1,ia:2,ca:3,es:5,ls:2,vcd:1,dme:1,anc:1,cir:1,examples:"T, VZ, TMUS"},
        {name:"Gaming / Interactive",sc:3,ne:4,ia:4,ca:2,es:2,ls:2,vcd:3,dme:3,anc:4,cir:3,examples:"EA, TTWO, RBLX"}],
      "Industrials":[
        {name:"Aerospace & Defense",sc:4,ne:1,ia:4,ca:4,es:5,ls:2,vcd:1,dme:1,anc:1,cir:1,examples:"LMT, RTX, BA"},
        {name:"Industrial Automation",sc:3,ne:1,ia:3,ca:3,es:3,ls:3,vcd:2,dme:2,anc:3,cir:2,examples:"ROK, EMR, HON"},
        {name:"Transportation / Logistics",sc:2,ne:2,ia:2,ca:3,es:3,ls:4,vcd:3,dme:2,anc:3,cir:3,examples:"UPS, FDX, UNP"},
        {name:"Staffing / HR Services",sc:1,ne:1,ia:1,ca:1,es:1,ls:5,vcd:5,dme:3,anc:5,cir:5,examples:"RHI, MAN, HAYS"}],
      "Energy":[
        {name:"Integrated Oil & Gas",sc:1,ne:1,ia:2,ca:5,es:5,ls:1,vcd:1,dme:1,anc:1,cir:1,examples:"XOM, CVX, COP"},
        {name:"E&P / Upstream",sc:1,ne:1,ia:2,ca:3,es:3,ls:1,vcd:1,dme:1,anc:1,cir:1,examples:"PXD, EOG, DVN"},
        {name:"Oilfield Services",sc:2,ne:1,ia:3,ca:3,es:3,ls:2,vcd:1,dme:1,anc:2,cir:1,examples:"SLB, HAL, BKR"},
        {name:"Renewables / Clean Energy",sc:2,ne:1,ia:3,ca:2,es:2,ls:1,vcd:1,dme:1,anc:2,cir:1,examples:"ENPH, FSLR, NEE"}],
      "Consumer Staples":[
        {name:"Beverages",sc:2,ne:1,ia:5,ca:4,es:3,ls:1,vcd:1,dme:1,anc:1,cir:1,examples:"KO, PEP, STZ"},
        {name:"Packaged Food",sc:1,ne:1,ia:4,ca:4,es:2,ls:1,vcd:2,dme:1,anc:2,cir:1,examples:"PG, MDLZ, GIS"},
        {name:"Retail / Grocery",sc:2,ne:1,ia:3,ca:4,es:3,ls:2,vcd:3,dme:2,anc:2,cir:2,examples:"WMT, COST, KR"}],
      "Utilities":[
        {name:"Regulated Electric",sc:3,ne:1,ia:2,ca:3,es:5,ls:1,vcd:1,dme:1,anc:1,cir:1,examples:"NEE, DUK, SO"},
        {name:"Water / Gas",sc:2,ne:1,ia:2,ca:3,es:5,ls:1,vcd:1,dme:1,anc:1,cir:1,examples:"AWK, WM, SRE"}],
      "Real Estate":[
        {name:"Data Centers / Digital REITs",sc:4,ne:2,ia:3,ca:3,es:3,ls:1,vcd:1,dme:2,anc:2,cir:1,examples:"EQIX, DLR, AMT"},
        {name:"Commercial / Office REITs",sc:2,ne:1,ia:1,ca:2,es:3,ls:3,vcd:5,dme:2,anc:3,cir:3,examples:"BXP, VNO, SLG"},
        {name:"Residential / Industrial REITs",sc:2,ne:1,ia:2,ca:2,es:3,ls:2,vcd:2,dme:1,anc:2,cir:2,examples:"PLD, EQR, AVB"}],
      "Materials":[
        {name:"Chemicals / Specialty",sc:2,ne:1,ia:3,ca:4,es:3,ls:1,vcd:1,dme:1,anc:1,cir:1,examples:"LIN, APD, DD"},
        {name:"Mining / Metals",sc:1,ne:1,ia:1,ca:5,es:4,ls:1,vcd:1,dme:1,anc:1,cir:1,examples:"FCX, NEM, BHP"}]
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMPUTATION FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function calcMoat(d) { return d.sc*0.25 + d.ne*0.20 + d.ia*0.25 + d.ca*0.15 + d.es*0.15; }
    function calcAI(d) { return d.ls*0.25 + d.vcd*0.25 + d.dme*0.15 + d.anc*0.20 + d.cir*0.15; }
    function CAP(m) { return m>=4?22:m>=3.5?18:m>=3?14:m>=2.5?10:m>=2?7:4; }
    function adjCAP(c, ai, bm=0) { return Math.max(2, Math.round(c*(1-Math.max(0,(ai-1.5)*0.15)-bm*0.05))); }
    function aiPrem(ai, bm=0) { return Math.min(400,(ai>=4?300:ai>=3.5?225:ai>=3?150:ai>=2.5?100:ai>=2?50:0)+bm*15); }
    function justPE(r,g,c) { if(r<=g)return 30; return Math.max(5,Math.min(50,(1/(r-g))*(1-Math.pow((1+g)/(1+r),c))+Math.pow((1+g)/(1+r),c)*(1/(r-0.02)))); }
    function tier(n) { return n<=-2?"CRITICAL":n<=-0.5?"HIGH":n<=0.5?"MEDIUM":n<=1.5?"LOW-MEDIUM":"LOW"; }

    function computeSComp(overrides = { sectors: {}, tickers: {} }) {
      const results = {};
      for (const [sector, base] of Object.entries(SECTOR_DB)) {
        const ov = overrides.sectors?.[sector] || {};
        const merged = { ...base, ...ov };
        const ms = calcMoat(merged), ai = calcAI(merged), net = ms - ai;
        const bCap = CAP(ms), aCap = adjCAP(bCap, ai), bp = aiPrem(ai);
        const wacc = 0.095, ltg = 0.03;
        const bPE = justPE(wacc, ltg, bCap), aPE = justPE(wacc + bp/10000, ltg, aCap);
        const hc = bPE > 0 ? (bPE - aPE) / bPE * 100 : 0;
        results[sector] = {
          moatScore: ms, aiScore: ai, netScore: net,
          tier: tier(net), baseCap: bCap, adjCap: aCap,
          aiPremBps: bp, basePE: +bPE.toFixed(1), adjPE: +aPE.toFixed(1),
          haircut: +hc.toFixed(1), ...merged,
        };
      }
      return results;
    }

    function computeSubComp() {
      return Object.entries(SUBSEC).flatMap(([sec, subs]) =>
        subs.map(d => {
          const m = calcMoat(d), a = calcAI(d);
          return { ...d, sector: sec, moat: +m.toFixed(2), aiRisk: +a.toFixed(2), net: +(m-a).toFixed(2) };
        })
      ).sort((a,b) => a.net - b.net);
    }

    function loadOverrides() {
      try { return JSON.parse(localStorage.getItem("pm_overrides") || '{"sectors":{},"tickers":{}}'); }
      catch(e) { return { sectors: {}, tickers: {} }; }
    }
    function saveOverrides(o) { localStorage.setItem("pm_overrides", JSON.stringify(o)); }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SVG CHART COMPONENTS (Chunk 2)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function RadarChart({ data, size = 200, color = C.ww1 }) {
      const cx = size/2, cy = size/2, r = size*0.34, n = data.length;
      const pt = (i, v) => {
        const a = Math.PI*2*i/n - Math.PI/2;
        return [cx + r*(v/5)*Math.cos(a), cy + r*(v/5)*Math.sin(a)];
      };
      const rings = [1,2,3,4,5].map(v => data.map((_,i) => pt(i,v).join(",")).join(" "));
      const dataPoints = data.map((d,i) => pt(i, d.s));
      const dataPoly = dataPoints.map(p => p.join(",")).join(" ");
      const labels = data.map((d,i) => {
        const a = Math.PI*2*i/n - Math.PI/2;
        return { x: cx+(r+18)*Math.cos(a), y: cy+(r+18)*Math.sin(a), label: d.d };
      });
      return html`
        <svg viewBox="0 0 ${size} ${size}" class="chart-svg radar-chart">
          ${rings.map((pts,i) => html`
            <polygon points="${pts}" fill="none" stroke="${C.border}" stroke-width="${i===4?1.5:0.5}" />`)}
          ${data.map((_,i) => { const [x1,y1]=pt(i,5); return html`
            <line x1="${cx}" y1="${cy}" x2="${x1}" y2="${y1}" stroke="${C.border}" stroke-width="0.5" />`; })}
          <polygon points="${dataPoly}" fill="${color}" fill-opacity="0.18" stroke="${color}" stroke-width="2" />
          ${dataPoints.map(([x,y]) => html`
            <circle cx="${x}" cy="${y}" r="3.5" fill="${color}" stroke="#fff" stroke-width="1.5" />`)}
          ${labels.map(p => html`
            <text x="${p.x}" y="${p.y}" text-anchor="middle" dominant-baseline="middle"
              fill="${C.dim}" font-size="10" font-weight="600">${p.label}</text>`)}
        </svg>`;
    }

    function HBarChart({ data, color }) {
      const W=340, H=28*data.length+20;
      const ml=105, mr=16, mt=8, mb=18, w=W-ml-mr, h=H-mt-mb;
      const bh = Math.min(18, h/data.length*0.65);
      const getColor = (v) => typeof color==="function" ? color(v) : v>=4?C.red:v>=3?C.orange:C.green;
      return html`
        <svg viewBox="0 0 ${W} ${H}" class="chart-svg hbar-chart">
          ${[0,1,2,3,4,5].map(v => { const x=ml+v/5*w; return html`
            <line x1="${x}" y1="${mt}" x2="${x}" y2="${H-mb}" stroke="${C.border}" stroke-width="0.5" />
            <text x="${x}" y="${H-mb+12}" text-anchor="middle" fill="${C.dim}" font-size="9">${v}</text>`; })}
          <line x1="${ml+3/5*w}" y1="${mt}" x2="${ml+3/5*w}" y2="${H-mb}"
            stroke="${C.red}" stroke-width="1" stroke-dasharray="4 3" opacity="0.4" />
          ${data.map((d,i) => {
            const y=mt+(i+0.5)*h/data.length-bh/2, bw=d.s/5*w, c=getColor(d.s);
            return html`
              <rect x="${ml}" y="${y}" width="${Math.max(2,bw)}" height="${bh}" rx="3" fill="${c}" />
              <text x="${ml-6}" y="${y+bh/2}" text-anchor="end" dominant-baseline="middle"
                fill="${C.dim}" font-size="10">${d.d}</text>`; })}
        </svg>`;
    }

    function VBarChart({ data, onClick }) {
      const W=360, H=260, ml=36, mr=8, mt=10, mb=70;
      const w=W-ml-mr, h=H-mt-mb, bw=Math.min(22, w/data.length*0.6);
      const mn=Math.min(...data.map(d=>d.net)), mx=Math.max(...data.map(d=>d.net));
      const range=Math.max(Math.abs(mn),Math.abs(mx),1)*1.2;
      const y0=mt+h*(range/(range*2));
      const barColor=(n)=>n>1?C.green:n>0?"#6bbd5b":n>-0.5?C.yellow:C.red;
      return html`
        <svg viewBox="0 0 ${W} ${H}" class="chart-svg vbar-chart">
          ${[-2,-1,0,1,2].filter(v=>v>=-range&&v<=range).map(v => {
            const y=mt+h*((range-v)/(range*2));
            return html`
              <line x1="${ml}" y1="${y}" x2="${W-mr}" y2="${y}"
                stroke="${v===0?C.dim:C.border}" stroke-width="${v===0?1:0.5}" />
              <text x="${ml-5}" y="${y}" text-anchor="end" dominant-baseline="middle"
                fill="${C.dim}" font-size="9">${v.toFixed(1)}</text>`; })}
          ${data.map((d,i) => {
            const x=ml+(i+0.5)*w/data.length-bw/2;
            const barH=Math.abs(d.net)/(range*2)*h, y=d.net>=0?y0-barH:y0;
            const c=barColor(d.net), short=d.name.split(" ")[0];
            return html`
              <rect x="${x}" y="${y}" width="${bw}" height="${Math.max(1,barH)}" rx="2" fill="${c}"
                onClick=${onClick?()=>onClick(d.name):null} />
              <text x="${x+bw/2}" y="${H-mb+10}" text-anchor="end" dominant-baseline="middle"
                fill="${C.dim}" font-size="7" transform="rotate(-35,${x+bw/2},${H-mb+10})">${short}</text>`; })}
        </svg>`;
    }

    function GroupedBarChart({ data, onClick }) {
      const W=360, H=26*data.length+50;
      const ml=100, mr=16, mt=30, mb=10, w=W-ml-mr, h=H-mt-mb;
      const bw=Math.min(9, w/data.length/3), gap=bw*0.4;
      return html`
        <svg viewBox="0 0 ${W} ${H}" class="chart-svg grouped-bar-chart">
          <rect x="${W-mr-130}" y="4" width="126" height="22" rx="4"
            fill="${C.cardBg}" stroke="${C.border}" stroke-width="0.5" />
          <rect x="${W-mr-122}" y="9" width="10" height="7" rx="2" fill="${C.ww1}" />
          <text x="${W-mr-108}" y="13.5" dominant-baseline="middle" fill="${C.dim}" font-size="8">Moat Strength</text>
          <rect x="${W-mr-60}" y="9" width="10" height="7" rx="2" fill="${C.orange}" />
          <text x="${W-mr-46}" y="13.5" dominant-baseline="middle" fill="${C.dim}" font-size="8">AI Risk</text>
          ${[0,1,2,3,4,5].map(v => { const x=ml+v/5*w; return html`
            <line x1="${x}" y1="${mt}" x2="${x}" y2="${mt+h}" stroke="${C.border}" stroke-width="0.5" />
            <text x="${x}" y="${mt+h+13}" text-anchor="middle" fill="${C.dim}" font-size="9">${v}</text>`; })}
          ${data.map((d,i) => {
            const y=mt+i*(h/data.length)+h/data.length*0.15;
            const moatW=(d.moatScore||0)/5*w, aiW=(d.aiScore||0)/5*w;
            const label=d.name||"", short=label.length>14?label.substring(0,13)+"â€¦":label;
            return html`
              <rect x="${ml}" y="${y}" width="${Math.max(2,moatW)}" height="${bw}" rx="2" fill="${C.ww1}"
                onClick=${onClick?()=>onClick(label):null} />
              <rect x="${ml}" y="${y+bw+gap}" width="${Math.max(2,aiW)}" height="${bw}" rx="2" fill="${C.orange}"
                onClick=${onClick?()=>onClick(label):null} />
              <text x="${ml-6}" y="${y+bw+gap/2}" text-anchor="end" dominant-baseline="middle"
                fill="${C.copy}" font-size="10" font-weight="500">${short}</text>`; })}
        </svg>`;
    }

    function LineChart({ data }) {
      const W=340, H=200, ml=36, mr=16, mt=15, mb=26;
      const w=W-ml-mr, h=H-mt-mb;
      const mx=Math.max(...data.map(d=>Math.max(d.base,d.adj)));
      const pt=(i,v)=>[ml+i/(data.length-1)*w, mt+h*(1-v/mx)];
      const basePts=data.map((d,i)=>pt(i,d.base)), adjPts=data.map((d,i)=>pt(i,d.adj));
      const areaPath="M"+basePts.map(p=>p.join(",")).join("L")+
        "L"+basePts[basePts.length-1][0]+","+(mt+h)+"L"+basePts[0][0]+","+(mt+h)+"Z";
      return html`
        <svg viewBox="0 0 ${W} ${H}" class="chart-svg line-chart">
          <defs><linearGradient id="capGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="${C.ww1}" stop-opacity="0.3" />
            <stop offset="100%" stop-color="${C.ww1}" stop-opacity="0" />
          </linearGradient></defs>
          ${[0,5,10,15].filter(v=>v<=mx).map(v => { const y=mt+h*(1-v/mx); return html`
            <line x1="${ml}" y1="${y}" x2="${W-mr}" y2="${y}" stroke="${C.border}" stroke-width="0.5" stroke-dasharray="3 3" />
            <text x="${ml-5}" y="${y}" text-anchor="end" dominant-baseline="middle" fill="${C.dim}" font-size="9">${v}</text>`; })}
          ${[0,5,10,15,20,25].map(v => { const x=ml+v/25*w; return html`
            <text x="${x}" y="${H-mb+13}" text-anchor="middle" fill="${C.dim}" font-size="9">${v}</text>`; })}
          <path d="${areaPath}" fill="url(#capGrad)" />
          <polyline points="${basePts.map(p=>p.join(",")).join(" ")}" fill="none" stroke="${C.ww1}" stroke-width="2" />
          <polyline points="${adjPts.map(p=>p.join(",")).join(" ")}" fill="none" stroke="${C.red}" stroke-width="2" stroke-dasharray="6 3" />
          <rect x="${W-mr-110}" y="${mt}" width="106" height="32" rx="4" fill="${C.cardBg}" stroke="${C.border}" stroke-width="0.5" />
          <line x1="${W-mr-102}" y1="${mt+10}" x2="${W-mr-86}" y2="${mt+10}" stroke="${C.ww1}" stroke-width="2" />
          <text x="${W-mr-82}" y="${mt+10}" dominant-baseline="middle" fill="${C.dim}" font-size="8">Base CAP</text>
          <line x1="${W-mr-102}" y1="${mt+22}" x2="${W-mr-86}" y2="${mt+22}" stroke="${C.red}" stroke-width="2" stroke-dasharray="4 2" />
          <text x="${W-mr-82}" y="${mt+22}" dominant-baseline="middle" fill="${C.dim}" font-size="8">AI+BM Adj</text>
        </svg>`;
    }

    function ScatterPlot({ data }) {
      const W=360, H=320, ml=42, mr=16, mt=16, mb=36;
      const w=W-ml-mr, h=H-mt-mb;
      const sc=(v,min,max)=>(v-min)/(max-min);
      return html`
        <svg viewBox="0 0 ${W} ${H}" class="chart-svg scatter-chart">
          ${[1,2,3,4,5].map(v => {
            const x=ml+sc(v,0.5,5)*w, y=mt+(1-sc(v,0.5,5))*h;
            return html`
              <line x1="${x}" y1="${mt}" x2="${x}" y2="${mt+h}" stroke="${C.border}" stroke-width="0.5" />
              <line x1="${ml}" y1="${y}" x2="${ml+w}" y2="${y}" stroke="${C.border}" stroke-width="0.5" />
              <text x="${x}" y="${H-mb+13}" text-anchor="middle" fill="${C.dim}" font-size="9">${v}</text>
              <text x="${ml-6}" y="${y}" text-anchor="end" dominant-baseline="middle" fill="${C.dim}" font-size="9">${v}</text>`; })}
          <line x1="${ml+sc(2.5,0.5,5)*w}" y1="${mt}" x2="${ml+sc(2.5,0.5,5)*w}" y2="${mt+h}"
            stroke="${C.dim}" stroke-width="0.8" stroke-dasharray="4 3" opacity="0.5" />
          <line x1="${ml}" y1="${mt+(1-sc(2.5,0.5,5))*h}" x2="${ml+w}" y2="${mt+(1-sc(2.5,0.5,5))*h}"
            stroke="${C.dim}" stroke-width="0.8" stroke-dasharray="4 3" opacity="0.5" />
          <text x="${ml+8}" y="${mt+12}" fill="${C.green}" font-size="7" opacity="0.6">STRONG MOAT / LOW RISK</text>
          <text x="${ml+w-4}" y="${mt+h-6}" fill="${C.red}" font-size="7" text-anchor="end" opacity="0.6">WEAK MOAT / HIGH RISK</text>
          ${data.map(d => {
            const x=ml+sc(d.ai,0.5,5)*w, y=mt+(1-sc(d.ms,0.5,5))*h;
            const tc=TIER_COLORS[d.t]||C.dim;
            return html`
              <circle cx="${x}" cy="${y}" r="8" fill="${tc}" fill-opacity="0.85" stroke="#fff" stroke-width="1.5" />
              <text x="${x}" y="${y-12}" text-anchor="middle" fill="${C.copy}" font-size="8" font-weight="700">${d.tk}</text>`; })}
          <text x="${ml+w/2}" y="${H-4}" text-anchor="middle" fill="${C.dim}" font-size="10">AI Disruption Risk â†’</text>
          <text x="12" y="${mt+h/2}" text-anchor="middle" dominant-baseline="middle" fill="${C.dim}" font-size="10"
            transform="rotate(-90,12,${mt+h/2})">â† Moat Strength</text>
        </svg>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SECTOR DETAIL + SUBSECTOR DRILL-DOWN (Chunk 2+3)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function SectorDetail({ sector, data, raw, onBack }) {
      const tc = TIER_COLORS[data.tier] || C.dim;
      const nc = data.netScore>1?C.green:data.netScore>0?"#6bbd5b":data.netScore>-0.5?C.yellow:C.red;
      const moatData = [{d:"SC",s:raw.sc},{d:"NE",s:raw.ne},{d:"IA",s:raw.ia},{d:"CA",s:raw.ca},{d:"ES",s:raw.es}];
      const aiData = [{d:"LS",s:raw.ls},{d:"VCD",s:raw.vcd},{d:"DME",s:raw.dme},{d:"ANC",s:raw.anc},{d:"CIR",s:raw.cir}];
      const capData = [];
      for (let yr=0; yr<=25; yr++) capData.push({ year:yr, base:Math.max(0,data.baseCap-yr*0.4), adj:Math.max(0,data.adjCap-yr*0.35) });

      // Subsector data
      const subs = useMemo(() => {
        return (SUBSEC[sector] || []).map(d => {
          const m = calcMoat(d), a = calcAI(d);
          return { ...d, moat: +m.toFixed(2), aiRisk: +a.toFixed(2), net: +(m-a).toFixed(2) };
        }).sort((a,b) => b.net - a.net);
      }, [sector]);

      return html`
        <div class="sector-detail">
          <button class="back-btn" onClick=${onBack}>â† Sectors</button>
          <div class="detail-header" style="border-left: 4px solid ${tc}">
            <div class="detail-title-row">
              <h2 class="detail-title">${sector}</h2>
              <span class="tier-badge-lg" style="background: ${tc}20; color: ${tc}">${data.tier}</span>
            </div>
            <div class="detail-net" style="color: ${nc}">Net: ${data.netScore>0?"+":""}${data.netScore.toFixed(2)}</div>
          </div>

          <div class="score-pills">
            <div class="pill"><span class="pill-label">Moat</span>
              <span class="pill-value" style="color: ${C.ww1}">${data.moatScore.toFixed(2)}</span></div>
            <div class="pill"><span class="pill-label">AI Risk</span>
              <span class="pill-value" style="color: ${C.orange}">${data.aiScore.toFixed(2)}</span></div>
            <div class="pill"><span class="pill-label">Adj CAP</span>
              <span class="pill-value">${data.adjCap}y</span></div>
            <div class="pill"><span class="pill-label">Haircut</span>
              <span class="pill-value" style="color: ${C.red}">-${data.haircut}%</span></div>
            <div class="pill"><span class="pill-label">AI Prem</span>
              <span class="pill-value" style="color: ${C.red}">+${data.aiPremBps}bp</span></div>
          </div>

          <div class="radar-pair">
            <div class="radar-col">
              <div class="radar-label">Moat Sources</div>
              <${RadarChart} data=${moatData} size=${200} color=${C.ww1} />
            </div>
            <div class="radar-col">
              <div class="radar-label">AI Risk Dimensions</div>
              <${RadarChart} data=${aiData} size=${200} color=${C.orange} />
            </div>
          </div>

          <div class="detail-section">
            <h3 class="section-title">Moat Factor Scores</h3>
            <div class="factor-grid">
              ${moatData.map(f => html`
                <div class="factor-item">
                  <span class="factor-abbr">${f.d}</span>
                  <span class="factor-name">${MOAT_LABELS[f.d.toLowerCase()]||f.d}</span>
                  <span class="factor-score" style="color: ${f.s>=4?C.green:f.s>=3?C.ww1:C.dim}">${f.s}/5</span>
                </div>`)}
            </div>
          </div>

          <div class="detail-section">
            <h3 class="section-title" style="color: ${C.orange}">AI Disruption Scores</h3>
            <${HBarChart} data=${aiData.map(f=>({d:AI_LABELS[f.d.toLowerCase()]||f.d, s:f.s}))}
              color=${v=>v>=4?C.red:v>=3?C.orange:C.green} />
          </div>

          <div class="detail-section">
            <h3 class="section-title">Competitive Advantage Period</h3>
            <p class="section-sub">Base ${data.baseCap}yr â†’ AI-adjusted ${data.adjCap}yr (${Math.round((1-data.adjCap/data.baseCap)*100)}% compression)</p>
            <${LineChart} data=${capData} />
          </div>

          ${subs.length > 0 && html`
            <div class="detail-section">
              <h3 class="section-title">Subsectors (${subs.length})</h3>
              <p class="section-sub">Differentiated AI disruption risk within ${sector}</p>
              <div class="sub-table-wrap">
                <table class="data-table sub-table">
                  <thead><tr>
                    <th style="text-align:left">Subsector</th>
                    <th>Moat</th><th>AI</th><th>Net</th>
                  </tr></thead>
                  <tbody>
                    ${subs.map(d => {
                      const snc = d.net>1?C.green:d.net>0?"#6bbd5b":d.net>-0.5?C.yellow:C.red;
                      return html`<tr>
                        <td style="font-weight:600;font-size:0.75rem">${d.name}<br/>
                          <span style="color:${C.dim};font-size:0.65rem;font-weight:400">${d.examples}</span></td>
                        <td style="text-align:center;color:${d.moat>=3.5?C.green:d.moat>=2.5?C.ww1:C.orange};font-weight:700">${d.moat}</td>
                        <td style="text-align:center;color:${d.aiRisk>=3.5?C.red:d.aiRisk>=2.5?C.orange:C.green};font-weight:700">${d.aiRisk}</td>
                        <td style="text-align:center;color:${snc};font-weight:800;font-size:0.9rem">${d.net>0?"+":""}${d.net}</td>
                      </tr>`;
                    })}
                  </tbody>
                </table>
              </div>
            </div>

            ${subs.map(d => {
              const snc = d.net>1?C.green:d.net>0?"#6bbd5b":d.net>-0.5?C.yellow:C.red;
              return html`
                <div class="sub-card" style="border-left: 3px solid ${snc}">
                  <div class="sub-card-header">
                    <span class="sub-card-name">${d.name}</span>
                    <span class="sub-card-net" style="color:${snc}">${d.net>0?"+":""}${d.net}</span>
                  </div>
                  <div class="sub-card-examples">${d.examples}</div>
                  <div class="radar-pair" style="margin-bottom:8px">
                    <div class="radar-col">
                      <div class="radar-label">Moat</div>
                      <${RadarChart} data=${[{d:"SC",s:d.sc},{d:"NE",s:d.ne},{d:"IA",s:d.ia},{d:"CA",s:d.ca},{d:"ES",s:d.es}]}
                        size=${160} color=${C.ww1} />
                    </div>
                    <div class="radar-col">
                      <div class="radar-label">AI Risk</div>
                      <${RadarChart} data=${[{d:"LS",s:d.ls},{d:"VCD",s:d.vcd},{d:"DME",s:d.dme},{d:"ANC",s:d.anc},{d:"CIR",s:d.cir}]}
                        size=${160} color=${C.orange} />
                    </div>
                  </div>
                  <div class="sub-card-footer">
                    <span style="color:${C.ww1}">Moat: ${d.moat}</span>
                    <span style="color:${C.orange}">AI: ${d.aiRisk}</span>
                  </div>
                </div>`;
            })}
          `}
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SECTOR CARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function SectorCard({ sector, data, onClick }) {
      const tc = TIER_COLORS[data.tier] || C.dim;
      const nc = data.netScore>1?C.green:data.netScore>0?"#6bbd5b":data.netScore>-0.5?C.yellow:C.red;
      const subCount = SUBSEC[sector]?.length || 0;
      return html`
        <div class="sector-card" style="border-left: 3px solid ${tc}" onClick=${onClick}>
          <div class="sector-header">
            <span class="sector-name">${sector}</span>
            <span class="tier-badge" style="background: ${tc}20; color: ${tc}">${data.tier}</span>
          </div>
          <div class="sector-scores">
            <div class="score-item"><span class="score-label">Moat</span>
              <span class="score-value" style="color: ${C.ww1}">${data.moatScore.toFixed(1)}</span></div>
            <div class="score-item"><span class="score-label">AI Risk</span>
              <span class="score-value" style="color: ${C.orange}">${data.aiScore.toFixed(1)}</span></div>
            <div class="score-item"><span class="score-label">Net</span>
              <span class="score-value" style="color: ${nc}">${data.netScore>0?"+":""}${data.netScore.toFixed(1)}</span></div>
            <div class="score-item"><span class="score-label">Haircut</span>
              <span class="score-value" style="color: ${C.red}">-${data.haircut}%</span></div>
          </div>
          ${subCount > 0 && html`<div class="card-sub-count">${subCount} subsectors â€º</div>`}
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WIKI TAB (Chunk 3)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function WikiTab() {
      return html`
        <div class="wiki-content">
          <h2 class="wiki-h1">ğŸ° AI Moat Risk Analyzer</h2>
          <p class="wiki-sub">Westwood Holdings Group Â· Superbad Investment Group</p>

          <div class="wiki-callout">
            <strong>Key Output:</strong> An AI-adjusted justified P/E ratio reflecting
            potential erosion of competitive advantages from AI disruption, expressed as
            a "haircut" percentage vs the base justified P/E.
          </div>

          <h3 class="wiki-h2">Moat Framework (Morningstar 5-Source)</h3>
          <p>Each company's moat is scored 1â€“5 across five dimensions, then weighted:</p>
          <table class="data-table wiki-table">
            <thead><tr><th>Source</th><th>Wt</th><th>What It Measures</th></tr></thead>
            <tbody>
              <tr><td><strong>SC</strong> Switching Costs</td><td>25%</td><td>Cost/pain of changing to a competitor</td></tr>
              <tr><td><strong>NE</strong> Network Effects</td><td>20%</td><td>Product value grows with more users</td></tr>
              <tr><td><strong>IA</strong> Intangible Assets</td><td>25%</td><td>Patents, brands, licenses, proprietary data</td></tr>
              <tr><td><strong>CA</strong> Cost Advantage</td><td>15%</td><td>Structural ability to produce at lower cost</td></tr>
              <tr><td><strong>ES</strong> Efficient Scale</td><td>15%</td><td>Market only supports limited competitors</td></tr>
            </tbody>
          </table>
          <div class="wiki-formula">Moat = SCÃ—0.25 + NEÃ—0.20 + IAÃ—0.25 + CAÃ—0.15 + ESÃ—0.15</div>

          <h3 class="wiki-h2">AI Disruption Risk (5-Dimension)</h3>
          <p>Five dimensions scored 1â€“5 (5 = highest risk):</p>
          <table class="data-table wiki-table">
            <thead><tr><th>Dimension</th><th>Wt</th><th>What It Measures</th></tr></thead>
            <tbody>
              <tr><td><strong>LS</strong> Labor Substitution</td><td>25%</td><td>Workforce replacement by AI</td></tr>
              <tr><td><strong>VCD</strong> Value Chain Disintermed.</td><td>25%</td><td>AI removes the middleman role</td></tr>
              <tr><td><strong>DME</strong> Data Moat Erosion</td><td>15%</td><td>AI commoditizes proprietary data</td></tr>
              <tr><td><strong>ANC</strong> AI-Native Competition</td><td>20%</td><td>Born-AI startups at fraction of cost</td></tr>
              <tr><td><strong>CIR</strong> Commodity Intelligence</td><td>15%</td><td>Core "intelligence" becomes commodity</td></tr>
            </tbody>
          </table>
          <div class="wiki-formula">AI Risk = LSÃ—0.25 + VCDÃ—0.25 + DMEÃ—0.15 + ANCÃ—0.20 + CIRÃ—0.15</div>

          <h3 class="wiki-h2">Competitive Advantage Period (CAP)</h3>
          <p>How many years a company sustains above-market returns. AI risk compresses this:</p>
          <table class="data-table wiki-table">
            <thead><tr><th>Moat Score</th><th>Base CAP</th><th>Interpretation</th></tr></thead>
            <tbody>
              <tr><td>4.0+</td><td>22yr</td><td>Wide moat â€” exceptional</td></tr>
              <tr><td>3.5â€“4.0</td><td>18yr</td><td>Strong moat</td></tr>
              <tr><td>3.0â€“3.5</td><td>14yr</td><td>Moderate moat</td></tr>
              <tr><td>2.5â€“3.0</td><td>10yr</td><td>Narrow moat</td></tr>
              <tr><td>2.0â€“2.5</td><td>7yr</td><td>Weak moat</td></tr>
              <tr><td>Below 2.0</td><td>4yr</td><td>No meaningful moat</td></tr>
            </tbody>
          </table>
          <div class="wiki-formula">Adj CAP = Base Ã— (1 âˆ’ max(0, (AIâˆ’1.5) Ã— 0.15) âˆ’ BMÃ—0.05), min 2yr</div>

          <h3 class="wiki-h2">WACC Premium (Damodaran)</h3>
          <p>AI adds a risk premium to cost of capital:</p>
          <table class="data-table wiki-table">
            <thead><tr><th>AI Risk</th><th>Premium</th></tr></thead>
            <tbody>
              <tr><td>Below 2.0</td><td>0bp</td></tr>
              <tr><td>2.0â€“2.5</td><td>+50bp</td></tr>
              <tr><td>2.5â€“3.0</td><td>+100bp</td></tr>
              <tr><td>3.0â€“3.5</td><td>+150bp</td></tr>
              <tr><td>3.5â€“4.0</td><td>+225bp</td></tr>
              <tr><td>4.0+</td><td>+300bp</td></tr>
            </tbody>
          </table>

          <h3 class="wiki-h2">The "Haircut"</h3>
          <p>The central output â€” how much less you should pay for earnings given AI risk:</p>
          <div class="wiki-formula">Haircut % = (Base P/E âˆ’ AI-Adjusted P/E) / Base P/E Ã— 100</div>
          <p><strong>Step 1:</strong> Compute base P/E using base WACC + full CAP (no AI).</p>
          <p><strong>Step 2:</strong> Recompute with AI WACC premium + compressed CAP.</p>
          <p><strong>Step 3:</strong> The difference is the haircut percentage.</p>
          <p>Driven by CAP compression (shorter premium-earnings window) and WACC expansion
          (future cash flows worth less today).</p>

          <h3 class="wiki-h2">Risk Tiers</h3>
          <table class="data-table wiki-table">
            <thead><tr><th>Net Range</th><th>Tier</th></tr></thead>
            <tbody>
              <tr><td>Above +1.5</td><td style="color:${C.green};font-weight:700">LOW</td></tr>
              <tr><td>+0.5 to +1.5</td><td style="color:${C.greenLt};font-weight:700">LOW-MEDIUM</td></tr>
              <tr><td>âˆ’0.5 to +0.5</td><td style="color:${C.yellow};font-weight:700">MEDIUM</td></tr>
              <tr><td>âˆ’2.0 to âˆ’0.5</td><td style="color:${C.orange};font-weight:700">HIGH</td></tr>
              <tr><td>Below âˆ’2.0</td><td style="color:${C.red};font-weight:700">CRITICAL</td></tr>
            </tbody>
          </table>

          <h3 class="wiki-h2">Data Sources</h3>
          <p><strong>Yahoo Finance</strong> â€” Free live market data (P/E, EPS, margins, beta, etc.)</p>
          <p><strong>FMP</strong> â€” Optional fallback for SEC-derived financials (250 calls/day free tier)</p>
          <p><strong>AI Provider</strong> â€” Claude/GPT-4o/Gemini for company-specific moat scoring (~$0.01-0.03/company)</p>
          <p><strong>Sector Defaults</strong> â€” Built-in GICS sector scores (no API needed)</p>

          <p class="wiki-footer">Built by Superbad Investment Group Â· Westwood Holdings Group Â·
          For Internal Use Only Â· Integrity. Reliability. Results.</p>
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SUMMARY PILLS (Chunk 3)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function SummaryPills({ sorted, subCount }) {
      const best = sorted[sorted.length - 1];
      const worst = sorted[0];
      return html`
        <div class="summary-pills">
          <div class="sum-pill"><span class="sum-label">Sectors</span><span class="sum-val" style="color:${C.ww1}">${sorted.length}</span></div>
          <div class="sum-pill"><span class="sum-label">Subsectors</span><span class="sum-val" style="color:${C.accent}">${subCount}</span></div>
          <div class="sum-pill"><span class="sum-label">Strongest</span><span class="sum-val" style="color:${C.green}">${best?.[0]?.split(" ")[0]}</span></div>
          <div class="sum-pill"><span class="sum-label">Most at Risk</span><span class="sum-val" style="color:${C.red}">${worst?.[0]?.split(" ")[0]}</span></div>
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // APP COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function App() {
      const [overrides, setOverrides] = useState(() => loadOverrides());
      const [activeTab, setActiveTab] = useState("sectors");
      const [selectedSector, setSelectedSector] = useState(null);
      const sComp = useMemo(() => computeSComp(overrides), [overrides]);
      const sorted = useMemo(() => Object.entries(sComp).sort((a,b) => a[1].netScore - b[1].netScore), [sComp]);
      const subComp = useMemo(() => computeSubComp(), []);
      const subCount = subComp.length;

      const chartData = useMemo(() =>
        sorted.map(([name,d]) => ({ name, net:d.netScore, moatScore:d.moatScore, aiScore:d.aiScore })), [sorted]);
      const scatterData = useMemo(() =>
        sorted.map(([name,d]) => ({ tk:name.split(" ")[0], ms:d.moatScore, ai:d.aiScore, t:d.tier, net:d.netScore })), [sorted]);

      return html`
        <div class="app">
          <header class="app-header">
            <h1>ğŸ° MOAT Analyzer</h1>
            <p class="subtitle">Competitive Moat & AI Disruption Risk</p>
          </header>

          <nav class="tab-bar">
            <button class="tab ${activeTab==='sectors'?'active':''}"
              onClick=${()=>{setActiveTab('sectors');setSelectedSector(null);}}>Sectors</button>
            <button class="tab ${activeTab==='charts'?'active':''}"
              onClick=${()=>setActiveTab('charts')}>Charts</button>
            <button class="tab ${activeTab==='wiki'?'active':''}"
              onClick=${()=>setActiveTab('wiki')}>Wiki</button>
            <button class="tab ${activeTab==='settings'?'active':''}"
              onClick=${()=>setActiveTab('settings')}>Settings</button>
          </nav>

          <main class="content">
            ${activeTab==='sectors' && !selectedSector && html`
              <${SummaryPills} sorted=${sorted} subCount=${subCount} />
              <div class="sector-list">
                ${sorted.map(([sector,data]) => html`
                  <${SectorCard} key=${sector} sector=${sector} data=${data}
                    onClick=${()=>setSelectedSector(sector)} />`)}
              </div>`}

            ${activeTab==='sectors' && selectedSector && html`
              <${SectorDetail} sector=${selectedSector} data=${sComp[selectedSector]}
                raw=${SECTOR_DB[selectedSector]} onBack=${()=>setSelectedSector(null)} />`}

            ${activeTab==='charts' && html`
              <div class="charts-view">
                <div class="chart-card">
                  <h3 class="chart-title">Moat vs AI Risk by Sector</h3>
                  <p class="chart-sub">Blue = moat strength, orange = AI disruption risk</p>
                  <${GroupedBarChart} data=${[...chartData].reverse()}
                    onClick=${(name)=>{setActiveTab('sectors');setSelectedSector(name);}} />
                </div>
                <div class="chart-card">
                  <h3 class="chart-title">Net Moat Score</h3>
                  <p class="chart-sub">Moat minus AI risk â€” green = protected, red = vulnerable</p>
                  <${VBarChart} data=${chartData}
                    onClick=${(name)=>{setActiveTab('sectors');setSelectedSector(name);}} />
                </div>
                <div class="chart-card">
                  <h3 class="chart-title">Sector Risk Map</h3>
                  <p class="chart-sub">Moat strength vs AI disruption risk</p>
                  <${ScatterPlot} data=${scatterData} />
                </div>
              </div>`}

            ${activeTab==='wiki' && html`<${WikiTab} />`}

            ${activeTab==='settings' && html`
              <div class="placeholder">
                <p>âš™ï¸ Settings coming in Chunk 5</p>
                <p class="dim">PM overrides, API keys, export</p>
              </div>`}
          </main>

          <footer class="app-footer">
            <span class="dim">MOAT Analyzer v3.0 â€” iOS PWA</span>
          </footer>
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MOUNT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    render(html`<${App} />`, document.getElementById('app'));
  </script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 15px; -webkit-text-size-adjust: 100%; -webkit-font-smoothing: antialiased; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      background: #0a0f1a; color: #e2e8f0;
      min-height: 100vh; min-height: -webkit-fill-available;
      overflow-x: hidden;
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .app { max-width: 100%; min-height: 100vh; display: flex; flex-direction: column; }
    .app-header { padding: 20px 16px 12px; text-align: center; border-bottom: 1px solid #1e2d3d; }
    .app-header h1 { font-size: 1.4rem; font-weight: 700; letter-spacing: -0.02em; }
    .subtitle { font-size: 0.8rem; color: #8899aa; margin-top: 2px; }

    .tab-bar {
      display: flex; padding: 8px 8px; border-bottom: 1px solid #1e2d3d;
      background: #111827; position: sticky; top: 0; z-index: 100;
    }
    .tab {
      flex: 1; padding: 10px 0; background: transparent; border: none;
      color: #8899aa; font-size: 0.78rem; font-weight: 600;
      cursor: pointer; border-radius: 8px; transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .tab.active { background: #1a2332; color: #4da3ff; }
    .content { flex: 1; padding: 12px 12px 80px; }

    /* Summary Pills */
    .summary-pills { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 12px; }
    .sum-pill { background: #111827; border-radius: 8px; padding: 8px 6px; text-align: center; }
    .sum-label { display: block; font-size: 0.6rem; color: #8899aa; text-transform: uppercase; letter-spacing: 0.05em; }
    .sum-val { display: block; font-size: 0.95rem; font-weight: 700; margin-top: 2px; }

    /* Sector Cards */
    .sector-list { display: flex; flex-direction: column; gap: 8px; }
    .sector-card {
      background: #111827; border-radius: 10px; padding: 12px 14px;
      cursor: pointer; transition: transform 0.15s, background 0.15s;
      -webkit-tap-highlight-color: transparent; position: relative;
    }
    .sector-card:active { transform: scale(0.98); background: #1a2332; }
    .sector-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .sector-name { font-size: 0.9rem; font-weight: 600; }
    .tier-badge { font-size: 0.65rem; font-weight: 700; padding: 2px 8px; border-radius: 4px; letter-spacing: 0.05em; }
    .sector-scores { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
    .score-item { text-align: center; }
    .score-label { display: block; font-size: 0.65rem; color: #8899aa; text-transform: uppercase; letter-spacing: 0.05em; }
    .score-value { display: block; font-size: 1rem; font-weight: 700; font-variant-numeric: tabular-nums; }
    .card-sub-count { font-size: 0.7rem; color: #4da3ff; margin-top: 6px; text-align: right; }

    /* Charts */
    .chart-svg { display: block; width: 100%; height: auto; max-width: 100%; }
    .radar-chart { max-width: 200px; margin: 0 auto; }
    .charts-view { display: flex; flex-direction: column; gap: 14px; }
    .chart-card { background: #111827; border-radius: 12px; padding: 16px 12px; }
    .chart-title { font-size: 0.9rem; font-weight: 700; color: #4da3ff; margin-bottom: 4px; }
    .chart-sub { font-size: 0.7rem; color: #8899aa; margin-bottom: 12px; }

    /* Sector Detail */
    .sector-detail { padding-bottom: 24px; }
    .back-btn {
      background: none; border: none; color: #4da3ff; font-size: 0.95rem;
      font-weight: 600; font-family: inherit; padding: 8px 0 16px;
      cursor: pointer; -webkit-tap-highlight-color: transparent;
    }
    .detail-header { background: #0f1929; border-radius: 12px; padding: 16px 18px; margin-bottom: 16px; }
    .detail-title-row { display: flex; justify-content: space-between; align-items: center; }
    .detail-title { font-size: 1.25rem; font-weight: 700; color: #e2e8f0; }
    .tier-badge-lg { font-size: 0.75rem; font-weight: 700; padding: 4px 12px; border-radius: 8px; letter-spacing: 0.05em; }
    .detail-net { font-size: 1.5rem; font-weight: 800; font-family: "SF Mono", ui-monospace, monospace; margin-top: 4px; }

    .score-pills { display: grid; grid-template-columns: repeat(auto-fit, minmax(85px, 1fr)); gap: 8px; margin-bottom: 20px; }
    .pill { background: #0f1929; border-radius: 10px; padding: 10px 8px; text-align: center; }
    .pill-label { display: block; font-size: 0.6rem; color: #8899aa; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px; }
    .pill-value { display: block; font-size: 1rem; font-weight: 700; font-family: "SF Mono", ui-monospace, monospace; color: #e2e8f0; }

    .radar-pair { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .radar-col { text-align: center; }
    .radar-label { font-size: 0.65rem; color: #8899aa; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 6px; }

    .detail-section { background: #0f1929; border-radius: 12px; padding: 16px; margin-bottom: 14px; }
    .section-title { font-size: 0.85rem; font-weight: 700; color: #4da3ff; margin-bottom: 8px; }
    .section-sub { font-size: 0.75rem; color: #8899aa; margin-bottom: 10px; }

    .factor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .factor-item { display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: #0a0f1a; border-radius: 8px; }
    .factor-abbr { font-size: 0.7rem; font-weight: 700; color: #8899aa; width: 28px; text-align: center; flex-shrink: 0; }
    .factor-name { font-size: 0.75rem; color: #c8d6e5; flex: 1; }
    .factor-score { font-size: 0.85rem; font-weight: 700; font-family: "SF Mono", ui-monospace, monospace; flex-shrink: 0; }

    /* Subsector Cards */
    .sub-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .sub-card {
      background: #111827; border-radius: 10px; padding: 14px;
      margin-bottom: 10px;
    }
    .sub-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .sub-card-name { font-size: 0.85rem; font-weight: 700; color: #e2e8f0; }
    .sub-card-net { font-size: 1.1rem; font-weight: 800; font-family: "SF Mono", ui-monospace, monospace; }
    .sub-card-examples { font-size: 0.7rem; color: #8899aa; margin-bottom: 10px; }
    .sub-card-footer { display: flex; justify-content: space-between; font-size: 0.75rem; }

    /* Tables */
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .data-table th { text-align: left; padding: 8px 6px; color: #8899aa; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #1e2d3d; }
    .data-table td { padding: 8px 6px; border-bottom: 1px solid #1e2d3d10; font-variant-numeric: tabular-nums; }
    .sub-table td, .sub-table th { padding: 6px 4px; }

    /* Wiki */
    .wiki-content { padding-bottom: 40px; }
    .wiki-h1 { font-size: 1.3rem; font-weight: 700; margin-bottom: 4px; }
    .wiki-sub { font-size: 0.8rem; color: #8899aa; margin-bottom: 16px; }
    .wiki-h2 { font-size: 1rem; font-weight: 700; color: #4da3ff; margin: 20px 0 8px; }
    .wiki-content p { font-size: 0.82rem; color: #c8d6e5; line-height: 1.5; margin-bottom: 8px; }
    .wiki-callout {
      background: #0f1929; border-left: 3px solid #4da3ff; border-radius: 8px;
      padding: 12px 14px; margin: 12px 0; font-size: 0.8rem; color: #c8d6e5; line-height: 1.5;
    }
    .wiki-formula {
      background: #0f1929; border-radius: 8px; padding: 10px 14px; margin: 8px 0 12px;
      font-family: "SF Mono", ui-monospace, monospace; font-size: 0.75rem; color: #4da3ff;
      overflow-x: auto; white-space: nowrap;
    }
    .wiki-table { margin: 8px 0 16px; }
    .wiki-table th { color: #4da3ff; }
    .wiki-table td { font-size: 0.78rem; }
    .wiki-footer { font-size: 0.7rem; color: #8899aa60; margin-top: 24px; text-align: center; }

    /* Forms (Chunk 5) */
    .input-field { background: #1a2332; border: 1px solid #1e2d3d; border-radius: 8px; padding: 10px 12px; color: #e2e8f0; font-size: 0.9rem; width: 100%; outline: none; -webkit-appearance: none; }
    .input-field:focus { border-color: #4da3ff; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; font-size: 0.85rem; cursor: pointer; -webkit-tap-highlight-color: transparent; transition: opacity 0.15s; }
    .btn:active { opacity: 0.8; }
    .btn-primary { background: #4da3ff; color: #0a0f1a; }
    .btn-secondary { background: #1a2332; color: #e2e8f0; border: 1px solid #1e2d3d; }

    .placeholder { text-align: center; padding: 60px 20px; color: #8899aa; }
    .placeholder p:first-child { font-size: 1.2rem; margin-bottom: 8px; }
    .dim { color: #8899aa; }
    .app-footer { padding: 12px; text-align: center; font-size: 0.7rem; border-top: 1px solid #1e2d3d; }

    @supports (-webkit-touch-callout: none) { .tab-bar { padding-top: max(8px, env(safe-area-inset-top)); } }
    html { overflow: hidden; height: 100%; }
    body { overflow-y: auto; height: 100%; -webkit-overflow-scrolling: touch; }
  </style>
</head>
<body>
  <div id="app">
    <div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#8899aa">
      Loading MOAT Analyzer...
    </div>
  </div>
</body>
</html>
