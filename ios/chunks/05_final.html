<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0f1a">
  <title>MOAT Analyzer</title>

  <script type="module">
    import { h, render } from 'https://esm.sh/preact@10.19.3';
    import { useState, useEffect, useMemo, useCallback, useRef } from 'https://esm.sh/preact@10.19.3/hooks';
    import htm from 'https://esm.sh/htm@3.1.1';
    const html = htm.bind(h);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONSTANTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const C = {
      bg: "#0a0f1a", cardBg: "#111827", bgAlt: "#1a2332",
      copy: "#e2e8f0", text: "#e2e8f0", dim: "#8899aa", border: "#1e2d3d",
      accent: "#4da3ff", ww1: "#326295", primary: "#326295",
      green: "#43b02a", greenLt: "#b3d57d",
      yellow: "#ede04b", orange: "#f39c12", red: "#e74c3c",
      grayMid: "#97999b", purple: "#a855f7", cyan: "#06b6d4",
    };

    const TIER_COLORS = {
      CRITICAL: C.red, HIGH: C.orange, MEDIUM: C.yellow,
      "LOW-MEDIUM": C.greenLt, LOW: C.green,
    };

    const MOAT_LABELS = {
      sc: "Switching Costs", ne: "Network Effects",
      ia: "Intangible Assets", ca: "Cost Advantage", es: "Efficient Scale",
    };

    const AI_LABELS = {
      ls: "Labor Substitution", vcd: "Value Chain Disruption",
      dme: "Data/Model Edge", anc: "Autonomous New Competition",
      cir: "Customer Interaction Risk",
    };

    const SECTOR_DB = {
      "Information Technology":  { sc:4, ne:4, ia:4, ca:3, es:2, ls:3, vcd:2, dme:3, anc:4, cir:3 },
      "Communication Services":  { sc:3, ne:5, ia:4, ca:2, es:3, ls:3, vcd:3, dme:4, anc:3, cir:4 },
      "Health Care":             { sc:3, ne:1, ia:5, ca:2, es:3, ls:2, vcd:2, dme:2, anc:3, cir:2 },
      "Financials":              { sc:3, ne:2, ia:3, ca:3, es:3, ls:5, vcd:4, dme:3, anc:4, cir:4 },
      "Consumer Staples":        { sc:2, ne:1, ia:4, ca:4, es:2, ls:2, vcd:2, dme:1, anc:2, cir:1 },
      "Industrials":             { sc:3, ne:1, ia:3, ca:4, es:3, ls:3, vcd:2, dme:2, anc:2, cir:2 },
      "Consumer Discretionary":  { sc:2, ne:2, ia:3, ca:2, es:1, ls:3, vcd:4, dme:3, anc:3, cir:3 },
      "Energy":                  { sc:1, ne:1, ia:2, ca:4, es:4, ls:1, vcd:1, dme:1, anc:1, cir:1 },
      "Utilities":               { sc:2, ne:1, ia:3, ca:3, es:5, ls:1, vcd:1, dme:1, anc:1, cir:1 },
      "Real Estate":             { sc:2, ne:1, ia:2, ca:2, es:3, ls:3, vcd:4, dme:2, anc:3, cir:3 },
      "Materials":               { sc:1, ne:1, ia:2, ca:4, es:3, ls:2, vcd:1, dme:1, anc:1, cir:1 },
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SUBSECTOR DATABASE (Chunk 3)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const SUBSEC = {
      "Information Technology":[
        {name:"Enterprise Software (SaaS)",sc:5,ne:3,ia:4,ca:2,es:2,ls:4,vcd:3,dme:3,anc:5,cir:4,examples:"CRM, WDAY, NOW"},
        {name:"Semiconductors",sc:3,ne:2,ia:5,ca:5,es:4,ls:1,vcd:1,dme:2,anc:2,cir:1,examples:"NVDA, AMD, INTC"},
        {name:"IT Services / Consulting",sc:3,ne:1,ia:2,ca:2,es:1,ls:5,vcd:4,dme:2,anc:4,cir:5,examples:"ACN, IBM, INFY"},
        {name:"Consumer Internet / Search",sc:4,ne:5,ia:4,ca:4,es:3,ls:2,vcd:2,dme:4,anc:4,cir:3,examples:"GOOGL, META"},
        {name:"Hardware / Devices",sc:4,ne:3,ia:4,ca:3,es:2,ls:1,vcd:1,dme:2,anc:3,cir:2,examples:"AAPL, DELL, HPQ"},
        {name:"Cybersecurity",sc:4,ne:2,ia:4,ca:2,es:2,ls:2,vcd:2,dme:3,anc:4,cir:3,examples:"CRWD, PANW, FTNT"}],
      "Health Care":[
        {name:"Pharma / Biotech",sc:2,ne:1,ia:5,ca:2,es:3,ls:1,vcd:1,dme:1,anc:2,cir:1,examples:"LLY, JNJ, PFE"},
        {name:"Medical Devices",sc:4,ne:1,ia:5,ca:3,es:3,ls:1,vcd:1,dme:1,anc:2,cir:1,examples:"MDT, SYK, ABT"},
        {name:"Health IT / Revenue Cycle",sc:5,ne:2,ia:3,ca:2,es:2,ls:4,vcd:3,dme:3,anc:4,cir:4,examples:"VEEV, HIMS"},
        {name:"Managed Care / Insurance",sc:3,ne:2,ia:3,ca:3,es:4,ls:3,vcd:3,dme:2,anc:3,cir:3,examples:"UNH, ELV, CI"},
        {name:"CRO / Life Sciences Tools",sc:3,ne:1,ia:4,ca:2,es:2,ls:3,vcd:2,dme:2,anc:3,cir:2,examples:"TMO, DHR, ICLR"}],
      "Financials":[
        {name:"Banks (Large/Universal)",sc:4,ne:2,ia:3,ca:3,es:4,ls:4,vcd:3,dme:2,anc:3,cir:3,examples:"JPM, BAC, WFC"},
        {name:"Insurance",sc:3,ne:1,ia:3,ca:3,es:3,ls:4,vcd:3,dme:2,anc:3,cir:3,examples:"BRK, PGR, MET"},
        {name:"Asset Management",sc:2,ne:1,ia:3,ca:2,es:2,ls:3,vcd:4,dme:3,anc:4,cir:4,examples:"BLK, BX, WHG"},
        {name:"Payments / Fintech",sc:4,ne:5,ia:3,ca:3,es:3,ls:3,vcd:4,dme:4,anc:5,cir:4,examples:"V, MA, SQ"},
        {name:"Brokerage / Exchanges",sc:3,ne:4,ia:3,ca:3,es:4,ls:4,vcd:4,dme:3,anc:4,cir:4,examples:"SCHW, ICE, CME"}],
      "Consumer Discretionary":[
        {name:"E-Commerce / Marketplace",sc:3,ne:5,ia:3,ca:3,es:2,ls:2,vcd:4,dme:4,anc:4,cir:3,examples:"AMZN, EBAY, ETSY"},
        {name:"Restaurants / QSR",sc:2,ne:1,ia:4,ca:3,es:2,ls:2,vcd:2,dme:1,anc:1,cir:1,examples:"MCD, SBUX, CMG"},
        {name:"Luxury / Apparel",sc:2,ne:2,ia:5,ca:1,es:1,ls:1,vcd:3,dme:2,anc:2,cir:1,examples:"NKE, LULU, TJX"},
        {name:"Auto / EV",sc:2,ne:1,ia:3,ca:3,es:3,ls:2,vcd:1,dme:1,anc:2,cir:1,examples:"TSLA, GM, F"},
        {name:"Travel / Leisure",sc:2,ne:3,ia:3,ca:2,es:2,ls:3,vcd:5,dme:3,anc:4,cir:3,examples:"BKNG, ABNB, MAR"}],
      "Communication Services":[
        {name:"Social Media / UGC Platforms",sc:4,ne:5,ia:4,ca:2,es:2,ls:2,vcd:2,dme:4,anc:4,cir:3,examples:"META, SNAP, PINS"},
        {name:"Streaming / Media",sc:2,ne:3,ia:4,ca:2,es:3,ls:2,vcd:4,dme:3,anc:3,cir:4,examples:"NFLX, DIS, WBD"},
        {name:"Telecom",sc:3,ne:1,ia:2,ca:3,es:5,ls:2,vcd:1,dme:1,anc:1,cir:1,examples:"T, VZ, TMUS"},
        {name:"Gaming / Interactive",sc:3,ne:4,ia:4,ca:2,es:2,ls:2,vcd:3,dme:3,anc:4,cir:3,examples:"EA, TTWO, RBLX"}],
      "Industrials":[
        {name:"Aerospace & Defense",sc:4,ne:1,ia:4,ca:4,es:5,ls:2,vcd:1,dme:1,anc:1,cir:1,examples:"LMT, RTX, BA"},
        {name:"Industrial Automation",sc:3,ne:1,ia:3,ca:3,es:3,ls:3,vcd:2,dme:2,anc:3,cir:2,examples:"ROK, EMR, HON"},
        {name:"Transportation / Logistics",sc:2,ne:2,ia:2,ca:3,es:3,ls:4,vcd:3,dme:2,anc:3,cir:3,examples:"UPS, FDX, UNP"},
        {name:"Staffing / HR Services",sc:1,ne:1,ia:1,ca:1,es:1,ls:5,vcd:5,dme:3,anc:5,cir:5,examples:"RHI, MAN, HAYS"}],
      "Energy":[
        {name:"Integrated Oil & Gas",sc:1,ne:1,ia:2,ca:5,es:5,ls:1,vcd:1,dme:1,anc:1,cir:1,examples:"XOM, CVX, COP"},
        {name:"E&P / Upstream",sc:1,ne:1,ia:2,ca:3,es:3,ls:1,vcd:1,dme:1,anc:1,cir:1,examples:"PXD, EOG, DVN"},
        {name:"Oilfield Services",sc:2,ne:1,ia:3,ca:3,es:3,ls:2,vcd:1,dme:1,anc:2,cir:1,examples:"SLB, HAL, BKR"},
        {name:"Renewables / Clean Energy",sc:2,ne:1,ia:3,ca:2,es:2,ls:1,vcd:1,dme:1,anc:2,cir:1,examples:"ENPH, FSLR, NEE"}],
      "Consumer Staples":[
        {name:"Beverages",sc:2,ne:1,ia:5,ca:4,es:3,ls:1,vcd:1,dme:1,anc:1,cir:1,examples:"KO, PEP, STZ"},
        {name:"Packaged Food",sc:1,ne:1,ia:4,ca:4,es:2,ls:1,vcd:2,dme:1,anc:2,cir:1,examples:"PG, MDLZ, GIS"},
        {name:"Retail / Grocery",sc:2,ne:1,ia:3,ca:4,es:3,ls:2,vcd:3,dme:2,anc:2,cir:2,examples:"WMT, COST, KR"}],
      "Utilities":[
        {name:"Regulated Electric",sc:3,ne:1,ia:2,ca:3,es:5,ls:1,vcd:1,dme:1,anc:1,cir:1,examples:"NEE, DUK, SO"},
        {name:"Water / Gas",sc:2,ne:1,ia:2,ca:3,es:5,ls:1,vcd:1,dme:1,anc:1,cir:1,examples:"AWK, WM, SRE"}],
      "Real Estate":[
        {name:"Data Centers / Digital REITs",sc:4,ne:2,ia:3,ca:3,es:3,ls:1,vcd:1,dme:2,anc:2,cir:1,examples:"EQIX, DLR, AMT"},
        {name:"Commercial / Office REITs",sc:2,ne:1,ia:1,ca:2,es:3,ls:3,vcd:5,dme:2,anc:3,cir:3,examples:"BXP, VNO, SLG"},
        {name:"Residential / Industrial REITs",sc:2,ne:1,ia:2,ca:2,es:3,ls:2,vcd:2,dme:1,anc:2,cir:2,examples:"PLD, EQR, AVB"}],
      "Materials":[
        {name:"Chemicals / Specialty",sc:2,ne:1,ia:3,ca:4,es:3,ls:1,vcd:1,dme:1,anc:1,cir:1,examples:"LIN, APD, DD"},
        {name:"Mining / Metals",sc:1,ne:1,ia:1,ca:5,es:4,ls:1,vcd:1,dme:1,anc:1,cir:1,examples:"FCX, NEM, BHP"}]
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMPUTATION FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function calcMoat(d) { return d.sc*0.25 + d.ne*0.20 + d.ia*0.25 + d.ca*0.15 + d.es*0.15; }
    function calcAI(d) { return d.ls*0.25 + d.vcd*0.25 + d.dme*0.15 + d.anc*0.20 + d.cir*0.15; }
    function CAP(m) { return m>=4?22:m>=3.5?18:m>=3?14:m>=2.5?10:m>=2?7:4; }
    function adjCAP(c, ai, bm=0) { return Math.max(2, Math.round(c*(1-Math.max(0,(ai-1.5)*0.15)-bm*0.05))); }
    function aiPrem(ai, bm=0) { return Math.min(400,(ai>=4?300:ai>=3.5?225:ai>=3?150:ai>=2.5?100:ai>=2?50:0)+bm*15); }
    function justPE(r,g,c) { if(r<=g)return 30; return Math.max(5,Math.min(50,(1/(r-g))*(1-Math.pow((1+g)/(1+r),c))+Math.pow((1+g)/(1+r),c)*(1/(r-0.02)))); }
    function tier(n) { return n<=-2?"CRITICAL":n<=-0.5?"HIGH":n<=0.5?"MEDIUM":n<=1.5?"LOW-MEDIUM":"LOW"; }

    function computeSComp(overrides = { sectors: {}, tickers: {} }) {
      const results = {};
      for (const [sector, base] of Object.entries(SECTOR_DB)) {
        const ov = overrides.sectors?.[sector] || {};
        const merged = { ...base, ...ov };
        const ms = calcMoat(merged), ai = calcAI(merged), net = ms - ai;
        const bCap = CAP(ms), aCap = adjCAP(bCap, ai), bp = aiPrem(ai);
        const wacc = 0.095, ltg = 0.03;
        const bPE = justPE(wacc, ltg, bCap), aPE = justPE(wacc + bp/10000, ltg, aCap);
        const hc = bPE > 0 ? (bPE - aPE) / bPE * 100 : 0;
        results[sector] = {
          moatScore: ms, aiScore: ai, netScore: net,
          tier: tier(net), baseCap: bCap, adjCap: aCap,
          aiPremBps: bp, basePE: +bPE.toFixed(1), adjPE: +aPE.toFixed(1),
          haircut: +hc.toFixed(1), ...merged,
        };
      }
      return results;
    }

    function computeSubComp() {
      return Object.entries(SUBSEC).flatMap(([sec, subs]) =>
        subs.map(d => {
          const m = calcMoat(d), a = calcAI(d);
          return { ...d, sector: sec, moat: +m.toFixed(2), aiRisk: +a.toFixed(2), net: +(m-a).toFixed(2) };
        })
      ).sort((a,b) => a.net - b.net);
    }

    function loadOverrides() {
      try { return JSON.parse(localStorage.getItem("pm_overrides") || '{"sectors":{},"tickers":{}}'); }
      catch(e) { return { sectors: {}, tickers: {} }; }
    }
    function saveOverrides(o) { localStorage.setItem("pm_overrides", JSON.stringify(o)); }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CHUNK 4: DATA FETCHING & TICKER ANALYSIS ENGINE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function pick(obj,...keys){for(const k of keys){const v=obj?.[k];if(v!=null&&v!==0&&v!=="")return v;}return 0;}
    function yR(v){return(v&&typeof v==="object"&&"raw" in v)?v.raw:(typeof v==="number"?v:0);}

    // CORS proxy rotation for Yahoo Finance
    async function corsProxy(url,timeout=10000){
      const attempts=[
        {u:url,label:"direct"},
        {u:`https://corsproxy.io/?url=${encodeURIComponent(url)}`,label:"corsproxy.io"},
        {u:`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,label:"allorigins"},
        {u:`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,label:"codetabs"},
      ];
      for(const{u,label} of attempts){
        try{
          const r=await fetch(u,{signal:AbortSignal.timeout(timeout)});
          if(!r.ok)continue;
          const txt=await r.text();
          try{return JSON.parse(txt);}catch(e){continue;}
        }catch(e){}
      }
      return null;
    }

    async function fetchYahoo(tk){
      const errs=[];
      const mods="financialData,defaultKeyStatistics,summaryDetail,summaryProfile,price";
      const sumUrl=`https://query1.finance.yahoo.com/v10/finance/quoteSummary/${tk}?modules=${mods}`;
      let d=await corsProxy(sumUrl);
      let res=d?.quoteSummary?.result?.[0];
      if(res){
        const fd=res.financialData||{},ks=res.defaultKeyStatistics||{},sd=res.summaryDetail||{},sp=res.summaryProfile||{},pr=res.price||{};
        return{name:pr.shortName||pr.longName||tk,ticker:(pr.symbol||tk).toUpperCase(),sector:sp.sector||"Unknown",industry:sp.industry||"Unknown",
          mktCap:yR(sd.marketCap)||yR(pr.marketCap),price:yR(fd.currentPrice)||yR(pr.regularMarketPrice),beta:yR(ks.beta)||1.0,
          peRatio:yR(sd.trailingPE)||yR(ks.trailingPE)||(yR(pr.regularMarketPrice)&&yR(ks.trailingEps)?yR(pr.regularMarketPrice)/yR(ks.trailingEps):0),
          forwardPE:yR(sd.forwardPE)||yR(ks.forwardPE)||0,roic:yR(fd.returnOnEquity)||0,roe:yR(fd.returnOnEquity)||0,
          grossMargin:yR(fd.grossMargins)||0,operatingMargin:yR(fd.operatingMargins)||0,netMargin:yR(fd.profitMargins)||0,
          fcfYield:yR(fd.freeCashflow)&&yR(sd.marketCap)?yR(fd.freeCashflow)/yR(sd.marketCap):0,
          debtToEquity:yR(fd.debtToEquity)?yR(fd.debtToEquity)/100:0,dividendYield:yR(sd.dividendYield)||yR(sd.trailingAnnualDividendYield)||0,
          evToEbitda:yR(ks.enterpriseToEbitda)||0,pbRatio:yR(sd.priceToBook)||yR(ks.priceToBook)||0,
          rdToRev:0,avgRevGrowth:yR(fd.revenueGrowth)||0.05,eps:yR(ks.trailingEps)||0,_ok:true,_errs:errs,_src:"yahoo"};
      }
      // v7 fallback
      const v7Url=`https://query2.finance.yahoo.com/v7/finance/quote?symbols=${tk}&fields=regularMarketPrice,marketCap,trailingPE,forwardPE,epsTrailingTwelveMonths,priceToBook,shortName,sector,industry,trailingAnnualDividendYield`;
      d=await corsProxy(v7Url);
      const q7=d?.quoteResponse?.result?.[0];
      if(q7){
        const pe=q7.trailingPE||(q7.regularMarketPrice&&q7.epsTrailingTwelveMonths?q7.regularMarketPrice/q7.epsTrailingTwelveMonths:0);
        return{name:q7.shortName||q7.longName||tk,ticker:(q7.symbol||tk).toUpperCase(),sector:q7.sector||"Unknown",industry:q7.industry||"Unknown",
          mktCap:q7.marketCap||0,price:q7.regularMarketPrice||0,beta:q7.beta||1.0,peRatio:pe||0,forwardPE:q7.forwardPE||0,
          roic:0,roe:0,grossMargin:0,operatingMargin:0,netMargin:0,fcfYield:0,debtToEquity:0,
          dividendYield:q7.trailingAnnualDividendYield||0,evToEbitda:0,pbRatio:q7.priceToBook||0,
          rdToRev:0,avgRevGrowth:0.05,eps:q7.epsTrailingTwelveMonths||0,_ok:true,_errs:["v7 only"],_src:"yahoo-v7"};
      }
      // v8 chart last resort
      const v8Url=`https://query1.finance.yahoo.com/v8/finance/chart/${tk}?interval=1d&range=5d`;
      d=await corsProxy(v8Url);
      const ch=d?.chart?.result?.[0];
      if(ch){const meta=ch.meta||{};return{name:tk,ticker:tk.toUpperCase(),sector:"Unknown",industry:"Unknown",mktCap:0,price:meta.regularMarketPrice||meta.previousClose||0,beta:1.0,peRatio:0,forwardPE:0,roic:0,roe:0,grossMargin:0,operatingMargin:0,netMargin:0,fcfYield:0,debtToEquity:0,dividendYield:0,evToEbitda:0,pbRatio:0,rdToRev:0,avgRevGrowth:0.05,eps:0,_ok:true,_errs:["chart only"],_src:"yahoo-chart"};}
      errs.push("yahoo:all-failed");
      return{_ok:false,_errs:errs,_src:"none"};
    }

    const FMP_BASE="https://financialmodelingprep.com/stable";
    async function fetchFMP(tk,key){
      const errs=[],urls={
        profile:`${FMP_BASE}/profile?symbol=${tk}&apikey=${key}`,
        quote:`${FMP_BASE}/quote?symbol=${tk}&apikey=${key}`,
        ratios:`${FMP_BASE}/ratios-ttm?symbol=${tk}&apikey=${key}`,
        metrics:`${FMP_BASE}/key-metrics-ttm?symbol=${tk}&apikey=${key}`,
        growth:`${FMP_BASE}/financial-growth?symbol=${tk}&limit=5&apikey=${key}`
      };
      const res={};
      await Promise.all(Object.entries(urls).map(async([k,u])=>{
        try{const r=await fetch(u);if(!r.ok){errs.push(k+":HTTP"+r.status);res[k]=[];return;}
          const d=await r.json();if(d?.["Error Message"]||!d||(Array.isArray(d)&&d.length===0)){errs.push(k+":empty");res[k]=[];return;}
          res[k]=Array.isArray(d)?d:[d];
        }catch(e){errs.push(k+":"+e.message);res[k]=[];}
      }));
      const p=res.profile?.[0]||{},q=res.quote?.[0]||{},rat=res.ratios?.[0]||{},m=res.metrics?.[0]||{},g=res.growth||[];
      const rg=g.filter(x=>x?.revenueGrowth!=null).map(x=>x.revenueGrowth);
      function scan(obj,pattern){if(!obj)return 0;for(const[k,v]of Object.entries(obj)){if(typeof v==="number"&&v!==0&&k.toLowerCase().includes(pattern))return v;}return 0;}
      return{
        name:p.companyName||tk,ticker:(p.symbol||tk).toUpperCase(),sector:p.sector||"Unknown",industry:p.industry||"Unknown",
        mktCap:q.marketCap||p.mktCap||0,price:q.price||p.price||0,beta:p.beta||1.0,
        peRatio:scan(q,"pe")||scan(rat,"priceearning")||scan(rat,"peratio")||(q.price&&q.eps?q.price/q.eps:0),
        roic:scan(m,"roic")||scan(rat,"roic")||scan(m,"returnoncapital")||0,
        roe:scan(m,"roe")||scan(rat,"returnonequity")||0,
        grossMargin:scan(rat,"grossprofit")||0,operatingMargin:scan(rat,"operatingprofit")||0,
        netMargin:scan(rat,"netprofit")||0,fcfYield:scan(m,"freecashflowyield")||0,
        debtToEquity:scan(rat,"debtequity")||0,dividendYield:scan(m,"dividendyield")||scan(rat,"dividendyield")||0,
        evToEbitda:scan(m,"enterprisevalue")||0,pbRatio:scan(m,"pbratio")||scan(rat,"pricetobook")||0,
        rdToRev:0,avgRevGrowth:rg.length>0?rg.reduce((a,b)=>a+b,0)/rg.length:0.05,
        _ok:!!(p.companyName||q.price),_errs:errs,_src:"fmp"
      };
    }

    async function fetchFinancials(tk,fmpKey){
      let yh=await fetchYahoo(tk);
      let fmp=null;
      if(fmpKey){try{fmp=await fetchFMP(tk,fmpKey);}catch(e){}}
      if(yh&&yh._ok&&yh.price){
        if(fmp&&fmp._ok){
          for(const k of["mktCap","beta","roic","roe","grossMargin","operatingMargin","netMargin","fcfYield","debtToEquity","dividendYield","evToEbitda","pbRatio","rdToRev","avgRevGrowth"]){
            if(!yh[k]&&fmp[k])yh[k]=fmp[k];
          }
          if(!yh.peRatio&&fmp.peRatio)yh.peRatio=fmp.peRatio;
          yh._src="yahoo+fmp";
        }
        return yh;
      }
      if(fmp&&fmp._ok)return fmp;
      return yh||{name:tk,ticker:tk,sector:"Unknown",industry:"Unknown",price:0,mktCap:0,beta:1,peRatio:0,roic:0,roe:0,grossMargin:0,operatingMargin:0,netMargin:0,fcfYield:0,debtToEquity:0,dividendYield:0,evToEbitda:0,pbRatio:0,rdToRev:0,avgRevGrowth:0.05,_ok:false,_errs:["all sources failed"],_src:"none"};
    }

    function extractJSON(t){if(!t)return null;let c=t.replace(/```json\s*/gi,"").replace(/```\s*/g,"").trim();try{return JSON.parse(c);}catch(e){}let d=0,s=-1;for(let i=0;i<c.length;i++){if(c[i]==="{"){if(d===0)s=i;d++;}else if(c[i]==="}"){d--;if(d===0&&s>=0){try{return JSON.parse(c.substring(s,i+1));}catch(e){s=-1;}}}}return null;}

    async function corsFetch(url,opts,timeout=15000){
      try{const r=await fetch(url,{...opts,signal:AbortSignal.timeout(timeout)});if(r.ok)return r;throw new Error("HTTP "+r.status);}
      catch(e){if(e.message.startsWith("HTTP "))throw e;}
      const proxyUrl="https://corsproxy.io/?url="+encodeURIComponent(url);
      const r=await fetch(proxyUrl,{...opts,signal:AbortSignal.timeout(timeout)});
      if(!r.ok)throw new Error("HTTP "+r.status+" (via proxy)");
      return r;
    }

    const LLM_PROVIDERS={
      claude:{name:"Claude",placeholder:"sk-ant-...",help:"console.anthropic.com â†’ API Keys",
        call:async(key,system,user)=>{
          const r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":key,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1500,system,messages:[{role:"user",content:user}]})});
          if(!r.ok){const t=await r.text().catch(()=>"");throw new Error("Claude HTTP "+r.status+" "+t.substring(0,100));}
          const d=await r.json();return extractJSON(d?.content?.filter(b=>b.type==="text").map(b=>b.text||"").join("\n"));
        }},
      openai:{name:"GPT-4o",placeholder:"sk-proj-...",help:"platform.openai.com â†’ API Keys",
        call:async(key,system,user)=>{
          const r=await corsFetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+key},body:JSON.stringify({model:"gpt-4o",max_tokens:1500,messages:[{role:"system",content:system},{role:"user",content:user}]})});
          const d=await r.json();if(d?.error)throw new Error(d.error.message||"OpenAI error");
          return extractJSON(d?.choices?.[0]?.message?.content);
        }},
      gemini:{name:"Gemini 2.0",placeholder:"AIza...",help:"aistudio.google.com â†’ API Keys",
        call:async(key,system,user)=>{
          const r=await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key="+key,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({system_instruction:{parts:[{text:system}]},contents:[{parts:[{text:user}]}],generationConfig:{maxOutputTokens:1500}})});
          if(!r.ok){const t=await r.text().catch(()=>"");throw new Error("Gemini HTTP "+r.status);}
          const d=await r.json();return extractJSON(d?.candidates?.[0]?.content?.parts?.[0]?.text);
        }},
    };

    const MOAT_SYSTEM='Return ONLY JSON:\n{"msRating":"Wide|Narrow|None","sc":3,"ne":3,"ia":3,"ca":3,"es":3,"ls":3,"vcd":3,"dme":3,"anc":3,"cir":3,"primaryMoatSource":"","keyVulnerabilities":"1 sentence","moatNarrative":"2 sentences","systemType":"System of Record|System of Action|Judgment Layer|Physical/Regulatory|Hybrid","capitalStructure":"Asset-Light|Medium|Heavy","valueDelivery":"Data Access|Workflow Automation|Domain Judgment|Physical Product|Platform/Marketplace","buyVsBuildRisk":3,"jtbdDensity":3,"moatDecayRate":"Months|1-2 Years|3-5 Years|5-10 Years|10+ Years","verticalVsHorizontal":"Deep Vertical|Moderate|Horizontal|Infrastructure","marginStructure":"LLM Wrapper|Value-Add Software|Domain Judgment Premium|Physical/Regulatory Premium","queenerTier":"Judgment Moat|Action Moat|Metadata Moat|Speed Moat|No Durable Moat","queenerDetail":"2 sentences","compositeRisk":2.5}\nMOAT 1-5(5=strong). AI RISK 1-5(5=high). compositeRisk 0-5. Be brutally honest.';
    const MOAT_FIN_SYSTEM='Return ONLY JSON with ALL fields:\n{"msRating":"Wide|Narrow|None","sc":3,"ne":3,"ia":3,"ca":3,"es":3,"ls":3,"vcd":3,"dme":3,"anc":3,"cir":3,"primaryMoatSource":"","keyVulnerabilities":"1 sentence","moatNarrative":"2 sentences","systemType":"System of Record|System of Action|Judgment Layer|Physical/Regulatory|Hybrid","capitalStructure":"Asset-Light|Medium|Heavy","valueDelivery":"Data Access|Workflow Automation|Domain Judgment|Physical Product|Platform/Marketplace","buyVsBuildRisk":3,"jtbdDensity":3,"moatDecayRate":"Months|1-2 Years|3-5 Years|5-10 Years|10+ Years","verticalVsHorizontal":"Deep Vertical|Moderate|Horizontal|Infrastructure","marginStructure":"LLM Wrapper|Value-Add Software|Domain Judgment Premium|Physical/Regulatory Premium","queenerTier":"Judgment Moat|Action Moat|Metadata Moat|Speed Moat|No Durable Moat","queenerDetail":"2 sentences","compositeRisk":2.5,\n"fin":{"name":"","sector":"","industry":"","price":0,"mktCap":0,"beta":1,"peRatio":0,"forwardPE":0,"roe":0,"roic":0,"grossMargin":0,"operatingMargin":0,"netMargin":0,"fcfYield":0,"debtToEquity":0,"dividendYield":0,"evToEbitda":0,"pbRatio":0,"avgRevGrowth":0.05}}\nMOAT 1-5. AI RISK 1-5. compositeRisk 0-5. The "fin" object must have current estimates. Be brutally honest.';

    async function fetchMoatBM(provider,apiKey,tk,sector,industry,needsFinancials=false){
      const prov=LLM_PROVIDERS[provider];
      if(!prov)throw new Error("Unknown provider: "+provider);
      const sys=needsFinancials?MOAT_FIN_SYSTEM:MOAT_SYSTEM;
      const prompt=needsFinancials?'Analyze '+tk+'. Financial data APIs failed â€” include your best financial estimates in the "fin" object.':'Analyze '+tk+' ('+sector+', '+industry+')';
      return prov.call(apiKey,sys,prompt);
    }

    function sectorDefault(sector){
      const s=SECTOR_DB[sector]||{sc:3,ne:2,ia:3,ca:3,es:2,ls:3,vcd:3,dme:3,anc:3,cir:3};
      return{...s,msRating:"Narrow",primaryMoatSource:"Sector Average",keyVulnerabilities:"Using sector defaults â€” add AI key in Settings for company-specific scoring",moatNarrative:"Sector-level defaults applied.",systemType:"Unknown",compositeRisk:0,queenerTier:"Unknown",buyVsBuildRisk:3,jtbdDensity:3};
    }

    function parseCSV(text){
      const tickers=[];
      for(const line of text.split(/[\n\r]+/)){
        const cells=line.split(/[,\t;|]+/).map(c=>c.trim());
        for(const c of cells){if(/^[A-Z]{1,5}$/.test(c)&&c!=="TICKER"&&c!=="SYMBOL"&&c!=="NAME")tickers.push(c);}
      }
      return[...new Set(tickers)];
    }

    function computeAll(fmp,moat,bmRisk){
      const ms=calcMoat(moat),ai=calcAI(moat),bmr=bmRisk?.compositeRisk||0;
      const net=ms-ai-bmr*0.3,t=tier(net),bCap=CAP(ms),aCap=adjCAP(bCap,ai,bmr);
      const bp=aiPrem(ai,bmr),wacc=Math.max(0.06,0.045+(fmp.beta||1)*0.05);
      const ltg=Math.min(0.04,Math.max(0.015,(fmp.avgRevGrowth||0.05)*0.4));
      const bPE=justPE(wacc,ltg,bCap),aPE=justPE(wacc+bp/10000,ltg,aCap);
      const haircut=bPE>0?(bPE-aPE)/bPE*100:0;
      const capData=Array.from({length:26},(_,i)=>({year:i,base:Math.max(0,15*Math.exp(-(1/bCap)*i)),adj:Math.max(0,15*Math.exp(-(1/aCap)*i))}));
      const secDef=SECTOR_DB[fmp.sector];
      let secHaircut=0,secNet=0,secTier="MEDIUM";
      if(secDef){
        const sm=calcMoat(secDef),sa=calcAI(secDef),sn=sm-sa;
        const sCap=CAP(sm),saCap=adjCAP(sCap,sa,0),sBp=aiPrem(sa,0);
        const sBPE=justPE(wacc,ltg,sCap),sAPE=justPE(wacc+sBp/10000,ltg,saCap);
        secHaircut=sBPE>0?(sBPE-sAPE)/sBPE*100:0;secNet=sn;secTier=tier(sn);
      }
      return{ms,ai,net,t,bCap,aCap,bp,wacc,ltg,bPE,aPE,haircut,capData,bmr,secHaircut,secNet,secTier};
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CHUNK 4: UI HELPER COMPONENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function APill({l,v,c,u=""}){
      return html`<div class="a-pill">
        <span class="a-pill-label">${l}</span>
        <span class="a-pill-value" style="color:${c||C.accent}">${v}${u && html`<span class="a-pill-unit">${u}</span>`}</span>
      </div>`;
    }

    function ATag({l,c}){
      return html`<span class="a-tag" style="color:${c||C.accent};border-color:${(c||C.accent)}40;background:${(c||C.accent)}14">${l}</span>`;
    }

    function ABadge({t,big}){
      const bg=TIER_COLORS[t]||C.grayMid;
      const dark=t==="MEDIUM"||t==="LOW-MEDIUM";
      return html`<span class="a-badge${big?' big':''}" style="background:${bg};color:${dark?'#111':'#fff'}">${t}</span>`;
    }

    function ASB({l,s,risk,w}){
      const c=risk?(s>=4?C.red:s>=3?C.orange:C.green):(s>=4?C.green:s>=3?C.yellow:C.red);
      return html`<div class="a-sb">
        <div class="a-sb-num" style="background:${c}18;color:${c}">${s}</div>
        <div class="a-sb-label">${l}${w && html`<span class="dim"> (${w})</span>`}</div>
        <div class="a-sb-bar"><div class="a-sb-fill" style="width:${s/5*100}%;background:${c}" /></div>
      </div>`;
    }

    function AIR({l,v,c}){
      return html`<div class="a-ir"><span class="dim">${l}</span><span style="color:${c||C.text};font-weight:600">${v}</span></div>`;
    }

    function bc(v){return v>=4?C.red:v>=3?C.orange:v>=2?C.yellow:C.green;}
    function dc(v){return v==="Months"?C.red:v==="1-2 Years"?C.orange:v==="3-5 Years"?C.yellow:C.green;}

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CHUNK 4: TICKER DETAIL VIEW
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function TickerDetail({r, onBack, detailTab, setDetailTab}){
      const fmt=(v,d=1)=>v!=null?Number(v).toFixed(d):"â€”";
      const fP=(v,d=1)=>v!=null?(v*100).toFixed(d)+"%":"â€”";
      const fM=v=>{if(!v)return"â€”";if(v>=1e12)return"$"+(v/1e12).toFixed(1)+"T";if(v>=1e9)return"$"+(v/1e9).toFixed(1)+"B";return"$"+(v/1e6).toFixed(0)+"M";};
      const tabs=["Overview","Moat","AI Risk","Biz Model","Valuation"];

      return html`<div class="ticker-detail">
        ${onBack && html`<button class="back-btn" onClick=${onBack}>â† Back to Portfolio</button>`}

        <div class="ticker-header">
          <div class="ticker-top-row">
            <span class="ticker-symbol">${r.fmp?.ticker||r.ticker}</span>
            <span class="ticker-name">${r.fmp?.name}</span>
          </div>
          <div class="tag-row">
            <${ATag} l=${r.fmp?.sector||"â€”"} c=${C.grayMid} />
            <${ATag} l=${(r.moat?.msRating||"Narrow")+" Moat"} c=${r.moat?.msRating==="Wide"?C.green:r.moat?.msRating==="Narrow"?C.yellow:C.red} />
            ${r.bmRisk?.queenerTier&&r.bmRisk.queenerTier!=="Unknown"&&html`<${ATag} l=${r.bmRisk.queenerTier} c=${C.accent} />`}
            <${ABadge} t=${r.comp?.t} />
          </div>
          <div class="score-pills">
            <${APill} l="Price" v=${"$"+fmt(r.fmp?.price,2)} c=${C.text} />
            <${APill} l="Mkt Cap" v=${fM(r.fmp?.mktCap)} c=${C.text} />
            <${APill} l="ROIC" v=${fP(r.fmp?.roic)} c=${(r.fmp?.roic||0)>(r.comp?.wacc||.08)?C.green:C.red} />
            <${APill} l="AI-Adj P/E" v=${fmt(r.comp?.aPE)} c=${(r.comp?.haircut||0)>15?C.red:C.orange} u="x" />
            <${APill} l="Haircut" v=${"-"+fmt(r.comp?.haircut)} c=${C.red} u="%" />
          </div>
        </div>

        ${r.st && html`<div class="status-bar ${r.st.data?.startsWith("âœ“")?"ok":"warn"}">
          <div class="status-items">
            <span>ğŸ“Š <strong>${r.st.data?.startsWith("âœ“")?"Data":"Data"}</strong>: ${r.st.data}</span>
            <span>ğŸ§  <strong>Moat</strong>: ${r.st.moat}</span>
          </div>
          ${!r.fmp?._ok&&r.fmp?._src!=="ai-estimated"&&html`<div class="status-note">âš  Financial data sources failed. Add API keys in Settings.</div>`}
        </div>`}

        ${(()=>{try{const n=JSON.parse(localStorage.getItem("moat_pm_notes")||"{}");const note=n[(r.fmp?.ticker||r.ticker)];if(note)return html`<div class="detail-section" style="border-left:3px solid ${C.yellow};margin:8px 0"><div style="font-size:0.68rem;color:${C.yellow};font-weight:700;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px">PM Note</div><p style="font-size:0.82rem;color:${C.text};line-height:1.5;margin:0">${note}</p></div>`;return null;}catch(e){return null;}})()}

        <div class="detail-tabs">
          ${tabs.map((t,i)=>html`<button key=${i} class="dtab${detailTab===i?' active':''}" onClick=${()=>setDetailTab(i)}>${t}</button>`)}
        </div>

        ${detailTab===0 && html`<div class="detail-pane">
          <div class="score-pills">
            <${APill} l="Moat" v=${fmt(r.comp.ms,2)} c=${r.comp.ms>=3.5?C.green:r.comp.ms>=2.5?C.orange:C.red} />
            <${APill} l="AI Risk" v=${fmt(r.comp.ai,2)} c=${r.comp.ai>=3.5?C.red:r.comp.ai>=2.5?C.orange:C.green} />
            <${APill} l="BM Risk" v=${fmt(r.comp.bmr,1)} c=${bc(r.comp.bmr)} />
            <${APill} l="Net Moat" v=${fmt(r.comp.net,2)} c=${r.comp.net>0?C.green:C.red} />
            <${APill} l="CAP" v=${r.comp.bCap+"â†’"+r.comp.aCap} c=${C.accent} u="yr" />
            <${APill} l="AI Prem" v=${"+"+r.comp.bp} c=${C.orange} u="bp" />
          </div>
          <div class="detail-section">
            <div class="section-title">Moat Assessment</div>
            <p style="font-size:0.82rem;line-height:1.6;color:${C.text}">${r.moat?.moatNarrative}</p>
            <p style="font-size:0.78rem;margin-top:8px;color:${C.orange}"><strong>Vulnerability:</strong> ${r.moat?.keyVulnerabilities}</p>
          </div>
          ${r.bmRisk?.systemType&&r.bmRisk.systemType!=="Unknown"&&html`<div class="detail-section">
            <div class="section-title">Business Model Risk</div>
            <div class="tag-row" style="margin-bottom:8px">
              <${ATag} l=${r.bmRisk.systemType} c=${C.accent} />
              ${r.bmRisk.capitalStructure&&html`<${ATag} l=${r.bmRisk.capitalStructure} c=${C.cyan} />`}
              ${r.bmRisk.moatDecayRate&&html`<${ATag} l=${"Decay: "+r.bmRisk.moatDecayRate} c=${dc(r.bmRisk.moatDecayRate)} />`}
            </div>
            <p style="font-size:0.82rem;line-height:1.6;color:${C.text}">${r.bmRisk.queenerDetail}</p>
          </div>`}
        </div>`}

        ${detailTab===1 && html`<div class="detail-pane">
          <div class="radar-pair">
            <div class="radar-col"><div class="radar-label">Moat Sources</div>
              <${RadarChart} data=${[{d:"SC",s:r.moat.sc},{d:"NE",s:r.moat.ne},{d:"IA",s:r.moat.ia},{d:"CA",s:r.moat.ca},{d:"ES",s:r.moat.es}]} size=${160} /></div>
            <div class="radar-col"><div class="radar-label">Scores (${fmt(r.comp.ms,2)}/5)</div>
              <${ASB} l="Switching Costs" s=${r.moat.sc} w="25%" />
              <${ASB} l="Network Effects" s=${r.moat.ne} w="20%" />
              <${ASB} l="Intangible Assets" s=${r.moat.ia} w="25%" />
              <${ASB} l="Cost Advantage" s=${r.moat.ca} w="15%" />
              <${ASB} l="Efficient Scale" s=${r.moat.es} w="15%" />
            </div>
          </div>
        </div>`}

        ${detailTab===2 && html`<div class="detail-pane">
          <div class="radar-pair">
            <div class="radar-col"><div class="radar-label">AI Disruption</div>
              <${HBarChart} data=${[{d:"Labor",s:r.moat.ls},{d:"Disint.",s:r.moat.vcd},{d:"Data",s:r.moat.dme},{d:"AI-Nat.",s:r.moat.anc},{d:"Comm.",s:r.moat.cir}]} color=${v=>v>=4?C.red:v>=3?C.orange:C.green} /></div>
            <div class="radar-col"><div class="radar-label">Scores (${fmt(r.comp.ai,2)}/5)</div>
              <${ASB} l="Labor Sub." s=${r.moat.ls} risk w="25%" />
              <${ASB} l="Disintermediation" s=${r.moat.vcd} risk w="25%" />
              <${ASB} l="Data Erosion" s=${r.moat.dme} risk w="15%" />
              <${ASB} l="AI-Native Comp." s=${r.moat.anc} risk w="20%" />
              <${ASB} l="Commodity Intel." s=${r.moat.cir} risk w="15%" />
            </div>
          </div>
        </div>`}

        ${detailTab===3 && html`<div class="detail-pane">
          ${r.bmRisk?.systemType&&r.bmRisk.systemType!=="Unknown"?html`
            <div class="detail-section">
              <div class="section-title">Westwood Research Moat Ladder</div>
              ${["No Durable Moat","Speed Moat","Metadata Moat","Action Moat","Judgment Moat"].map((m,i)=>{
                const a=r.bmRisk.queenerTier===m;
                const cl=[C.red,C.orange,C.yellow,C.greenLt,C.green][i];
                return html`<div class="ladder-rung${a?' active':''}" style="border-color:${a?cl:C.border};background:${a?cl+'18':'transparent'}">
                  <div class="ladder-num" style="background:${cl}">${i+1}</div>
                  <div style="flex:1;font-size:0.85rem;font-weight:${a?700:500};color:${a?cl:C.dim}">${m}</div>
                  ${a && html`<span style="color:${cl}">â—</span>`}
                </div>`;
              })}
              <p style="font-size:0.82rem;line-height:1.6;color:${C.text};margin-top:12px">${r.bmRisk.queenerDetail}</p>
            </div>
            <div class="detail-section">
              <div class="section-title">Risk Dimensions (${fmt(r.bmRisk.compositeRisk,1)}/5)</div>
              <${AIR} l="System Type" v=${r.bmRisk.systemType} c=${C.accent} />
              <${AIR} l="Capital" v=${r.bmRisk.capitalStructure||"â€”"} />
              <${AIR} l="Value" v=${r.bmRisk.valueDelivery||"â€”"} />
              <${AIR} l="Decay" v=${r.bmRisk.moatDecayRate||"â€”"} c=${dc(r.bmRisk.moatDecayRate)} />
              <${AIR} l="Margin" v=${r.bmRisk.marginStructure||"â€”"} c=${C.orange} />
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px">
                <div class="big-metric"><div class="big-metric-label">Buy vs Build</div>
                  <div class="big-metric-val" style="color:${bc(r.bmRisk.buyVsBuildRisk||0)}">${r.bmRisk.buyVsBuildRisk||"â€”"}<span class="dim">/5</span></div></div>
                <div class="big-metric"><div class="big-metric-label">JTBD Density</div>
                  <div class="big-metric-val" style="color:${(r.bmRisk.jtbdDensity||0)>=3?C.green:C.orange}">${r.bmRisk.jtbdDensity||"â€”"}<span class="dim">/5</span></div></div>
              </div>
            </div>`
          :html`<div class="detail-section"><p class="dim">Add AI key in Settings for business model analysis</p></div>`}
        </div>`}

        ${detailTab===4 && html`<div class="detail-pane">
          <div class="detail-section">
            <div class="section-title">CAP Compression</div>
            <p class="dim" style="margin-bottom:8px">Base ${r.comp.bCap}yr â†’ Adj ${r.comp.aCap}yr</p>
            <${LineChart} data=${r.comp.capData} />
          </div>
          <div class="detail-section">
            <div class="section-title">Scenario Sensitivity</div>
            <div class="sub-table-wrap">
              <table class="data-table">
                <thead><tr>${["Scenario","WACC+","CAP","P/E","Loss"].map(h=>html`<th style="text-align:center">${h}</th>`)}</tr></thead>
                <tbody>
                  ${[{s:"None",w:0,c:r.comp.bCap,cl:C.green},{s:"Low",w:50,c:r.comp.bCap-2,cl:C.greenLt},{s:"Moderate",w:150,c:Math.max(3,r.comp.bCap-5),cl:C.yellow},{s:"High",w:250,c:Math.max(3,r.comp.bCap-8),cl:C.orange},{s:"Severe",w:350,c:Math.max(2,r.comp.bCap-12),cl:C.red}].map(row=>{
                    const pe=justPE(r.comp.wacc+row.w/10000,r.comp.ltg,row.c);
                    const l=r.comp.bPE>0?((r.comp.bPE-pe)/r.comp.bPE*100):0;
                    return html`<tr><td style="font-weight:700;color:${row.cl};text-align:center">${row.s}</td>
                      <td style="text-align:center">+${row.w}bp</td><td style="text-align:center">${row.c}yr</td>
                      <td style="text-align:center;color:${C.accent};font-weight:700">${fmt(pe)}x</td>
                      <td style="text-align:center;color:${row.cl};font-weight:700">${l>0?"-"+fmt(l)+"%":"â€”"}</td></tr>`;
                  })}
                </tbody>
              </table>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:12px">
              <div class="big-metric"><div class="big-metric-label">Tier</div><${ABadge} t=${r.comp.t} big /></div>
              <div class="big-metric"><div class="big-metric-label">Sector Hcut</div><div class="big-metric-val" style="color:${C.orange}">-${fmt(r.comp.secHaircut)}%</div></div>
              <div class="big-metric"><div class="big-metric-label">Company Hcut</div><div class="big-metric-val" style="color:${C.red}">-${fmt(r.comp.haircut)}%</div></div>
            </div>
          </div>
        </div>`}
      </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CHUNK 4: PORTFOLIO VIEW
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function PortfolioView({portfolio, onSelect, portTab, setPortTab}){
      const fmt=(v,d=1)=>v!=null?Number(v).toFixed(d):"â€”";
      const tabs=["Portfolio","Risk Map","Biz Models"];
      return html`<div>
        <div class="detail-tabs">
          ${tabs.map((t,i)=>html`<button key=${i} class="dtab${portTab===i?' active':''}" onClick=${()=>setPortTab(i)}>${t}</button>`)}
        </div>

        ${portTab===0 && html`<div class="sub-table-wrap">
          <table class="data-table" style="font-size:0.72rem">
            <thead><tr>
              ${["Ticker","Moat","AI","BM","Net","Tier","Adj P/E","Hcut"].map(h=>html`<th style="text-align:center;font-size:0.6rem">${h}</th>`)}
            </tr></thead>
            <tbody>
              ${portfolio.map(d=>{
                const nc=d.comp.net>1?C.green:d.comp.net>0?C.greenLt:d.comp.net>-0.5?C.yellow:C.red;
                return html`<tr class="port-row" onClick=${()=>onSelect(d)}>
                  <td style="font-weight:700;color:${C.accent};font-family:monospace">${d.ticker}</td>
                  <td style="text-align:center;color:${d.comp.ms>=3.5?C.green:d.comp.ms>=2.5?C.accent:C.orange};font-weight:700">${d.comp.ms.toFixed(1)}</td>
                  <td style="text-align:center;color:${d.comp.ai>=3.5?C.red:d.comp.ai>=2.5?C.orange:C.green};font-weight:700">${d.comp.ai.toFixed(1)}</td>
                  <td style="text-align:center;color:${bc(d.comp.bmr)};font-weight:700">${d.comp.bmr.toFixed(1)}</td>
                  <td style="text-align:center;color:${nc};font-weight:800">${d.comp.net>0?"+":""}${d.comp.net.toFixed(2)}</td>
                  <td style="text-align:center"><${ABadge} t=${d.comp.t} /></td>
                  <td style="text-align:center;color:${d.comp.haircut>15?C.red:C.orange};font-weight:700">${d.comp.aPE.toFixed(1)}x</td>
                  <td style="text-align:center;color:${C.red};font-weight:700">-${d.comp.haircut.toFixed(0)}%</td>
                </tr>`;
              })}
            </tbody>
          </table>
        </div>`}

        ${portTab===1 && html`<div class="chart-card" style="margin-top:8px">
          <div class="chart-title">Moat vs AI Risk Map</div>
          <div class="chart-sub">Tap any dot to drill down</div>
          <${ScatterPlot} data=${portfolio.map(d=>({tk:d.ticker,ms:d.comp.ms,ai:d.comp.ai,t:d.comp.t,net:d.comp.net}))} />
        </div>`}

        ${portTab===2 && html`<div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          ${portfolio.map(d=>{
            const nc=d.comp.net>1?C.green:d.comp.net>0?C.greenLt:d.comp.net>-0.5?C.yellow:C.red;
            return html`<div class="sector-card" onClick=${()=>onSelect(d)}>
              <div class="sector-header">
                <span style="font-family:monospace;font-weight:800;color:${C.accent};font-size:0.95rem">${d.ticker}</span>
                <${ABadge} t=${d.comp.t} />
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:8px">
                <div style="text-align:center"><div style="font-size:0.6rem;color:${C.dim};text-transform:uppercase">Moat</div><div style="font-size:1.1rem;font-weight:800;color:${d.comp.ms>=3?C.green:C.orange}">${d.comp.ms.toFixed(1)}</div></div>
                <div style="text-align:center"><div style="font-size:0.6rem;color:${C.dim};text-transform:uppercase">AI Risk</div><div style="font-size:1.1rem;font-weight:800;color:${d.comp.ai>=3?C.red:C.green}">${d.comp.ai.toFixed(1)}</div></div>
                <div style="text-align:center"><div style="font-size:0.6rem;color:${C.dim};text-transform:uppercase">Haircut</div><div style="font-size:1.1rem;font-weight:800;color:${C.red}">-${d.comp.haircut.toFixed(0)}%</div></div>
              </div>
              ${d.bmRisk?.queenerTier&&d.bmRisk.queenerTier!=="Unknown"&&html`<div style="margin-top:6px;font-size:0.75rem;color:${C.accent}"><strong>WR:</strong> ${d.bmRisk.queenerTier}</div>`}
            </div>`;
          })}
        </div>`}
      </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SVG CHART COMPONENTS (Chunk 2)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function RadarChart({ data, size = 200, color = C.ww1 }) {
      const cx = size/2, cy = size/2, r = size*0.34, n = data.length;
      const pt = (i, v) => {
        const a = Math.PI*2*i/n - Math.PI/2;
        return [cx + r*(v/5)*Math.cos(a), cy + r*(v/5)*Math.sin(a)];
      };
      const rings = [1,2,3,4,5].map(v => data.map((_,i) => pt(i,v).join(",")).join(" "));
      const dataPoints = data.map((d,i) => pt(i, d.s));
      const dataPoly = dataPoints.map(p => p.join(",")).join(" ");
      const labels = data.map((d,i) => {
        const a = Math.PI*2*i/n - Math.PI/2;
        return { x: cx+(r+18)*Math.cos(a), y: cy+(r+18)*Math.sin(a), label: d.d };
      });
      return html`
        <svg viewBox="0 0 ${size} ${size}" class="chart-svg radar-chart">
          ${rings.map((pts,i) => html`
            <polygon points="${pts}" fill="none" stroke="${C.border}" stroke-width="${i===4?1.5:0.5}" />`)}
          ${data.map((_,i) => { const [x1,y1]=pt(i,5); return html`
            <line x1="${cx}" y1="${cy}" x2="${x1}" y2="${y1}" stroke="${C.border}" stroke-width="0.5" />`; })}
          <polygon points="${dataPoly}" fill="${color}" fill-opacity="0.18" stroke="${color}" stroke-width="2" />
          ${dataPoints.map(([x,y]) => html`
            <circle cx="${x}" cy="${y}" r="3.5" fill="${color}" stroke="#fff" stroke-width="1.5" />`)}
          ${labels.map(p => html`
            <text x="${p.x}" y="${p.y}" text-anchor="middle" dominant-baseline="middle"
              fill="${C.dim}" font-size="10" font-weight="600">${p.label}</text>`)}
        </svg>`;
    }

    function HBarChart({ data, color }) {
      const W=340, H=28*data.length+20;
      const ml=105, mr=16, mt=8, mb=18, w=W-ml-mr, h=H-mt-mb;
      const bh = Math.min(18, h/data.length*0.65);
      const getColor = (v) => typeof color==="function" ? color(v) : v>=4?C.red:v>=3?C.orange:C.green;
      return html`
        <svg viewBox="0 0 ${W} ${H}" class="chart-svg hbar-chart">
          ${[0,1,2,3,4,5].map(v => { const x=ml+v/5*w; return html`
            <line x1="${x}" y1="${mt}" x2="${x}" y2="${H-mb}" stroke="${C.border}" stroke-width="0.5" />
            <text x="${x}" y="${H-mb+12}" text-anchor="middle" fill="${C.dim}" font-size="9">${v}</text>`; })}
          <line x1="${ml+3/5*w}" y1="${mt}" x2="${ml+3/5*w}" y2="${H-mb}"
            stroke="${C.red}" stroke-width="1" stroke-dasharray="4 3" opacity="0.4" />
          ${data.map((d,i) => {
            const y=mt+(i+0.5)*h/data.length-bh/2, bw=d.s/5*w, c=getColor(d.s);
            return html`
              <rect x="${ml}" y="${y}" width="${Math.max(2,bw)}" height="${bh}" rx="3" fill="${c}" />
              <text x="${ml-6}" y="${y+bh/2}" text-anchor="end" dominant-baseline="middle"
                fill="${C.dim}" font-size="10">${d.d}</text>`; })}
        </svg>`;
    }

    function VBarChart({ data, onClick }) {
      const W=360, H=260, ml=36, mr=8, mt=10, mb=70;
      const w=W-ml-mr, h=H-mt-mb, bw=Math.min(22, w/data.length*0.6);
      const mn=Math.min(...data.map(d=>d.net)), mx=Math.max(...data.map(d=>d.net));
      const range=Math.max(Math.abs(mn),Math.abs(mx),1)*1.2;
      const y0=mt+h*(range/(range*2));
      const barColor=(n)=>n>1?C.green:n>0?"#6bbd5b":n>-0.5?C.yellow:C.red;
      return html`
        <svg viewBox="0 0 ${W} ${H}" class="chart-svg vbar-chart">
          ${[-2,-1,0,1,2].filter(v=>v>=-range&&v<=range).map(v => {
            const y=mt+h*((range-v)/(range*2));
            return html`
              <line x1="${ml}" y1="${y}" x2="${W-mr}" y2="${y}"
                stroke="${v===0?C.dim:C.border}" stroke-width="${v===0?1:0.5}" />
              <text x="${ml-5}" y="${y}" text-anchor="end" dominant-baseline="middle"
                fill="${C.dim}" font-size="9">${v.toFixed(1)}</text>`; })}
          ${data.map((d,i) => {
            const x=ml+(i+0.5)*w/data.length-bw/2;
            const barH=Math.abs(d.net)/(range*2)*h, y=d.net>=0?y0-barH:y0;
            const c=barColor(d.net), short=d.name.split(" ")[0];
            return html`
              <rect x="${x}" y="${y}" width="${bw}" height="${Math.max(1,barH)}" rx="2" fill="${c}"
                onClick=${onClick?()=>onClick(d.name):null} />
              <text x="${x+bw/2}" y="${H-mb+10}" text-anchor="end" dominant-baseline="middle"
                fill="${C.dim}" font-size="7" transform="rotate(-35,${x+bw/2},${H-mb+10})">${short}</text>`; })}
        </svg>`;
    }

    function GroupedBarChart({ data, onClick }) {
      const W=360, H=26*data.length+50;
      const ml=100, mr=16, mt=30, mb=10, w=W-ml-mr, h=H-mt-mb;
      const bw=Math.min(9, w/data.length/3), gap=bw*0.4;
      return html`
        <svg viewBox="0 0 ${W} ${H}" class="chart-svg grouped-bar-chart">
          <rect x="${W-mr-130}" y="4" width="126" height="22" rx="4"
            fill="${C.cardBg}" stroke="${C.border}" stroke-width="0.5" />
          <rect x="${W-mr-122}" y="9" width="10" height="7" rx="2" fill="${C.ww1}" />
          <text x="${W-mr-108}" y="13.5" dominant-baseline="middle" fill="${C.dim}" font-size="8">Moat Strength</text>
          <rect x="${W-mr-60}" y="9" width="10" height="7" rx="2" fill="${C.orange}" />
          <text x="${W-mr-46}" y="13.5" dominant-baseline="middle" fill="${C.dim}" font-size="8">AI Risk</text>
          ${[0,1,2,3,4,5].map(v => { const x=ml+v/5*w; return html`
            <line x1="${x}" y1="${mt}" x2="${x}" y2="${mt+h}" stroke="${C.border}" stroke-width="0.5" />
            <text x="${x}" y="${mt+h+13}" text-anchor="middle" fill="${C.dim}" font-size="9">${v}</text>`; })}
          ${data.map((d,i) => {
            const y=mt+i*(h/data.length)+h/data.length*0.15;
            const moatW=(d.moatScore||0)/5*w, aiW=(d.aiScore||0)/5*w;
            const label=d.name||"", short=label.length>14?label.substring(0,13)+"â€¦":label;
            return html`
              <rect x="${ml}" y="${y}" width="${Math.max(2,moatW)}" height="${bw}" rx="2" fill="${C.ww1}"
                onClick=${onClick?()=>onClick(label):null} />
              <rect x="${ml}" y="${y+bw+gap}" width="${Math.max(2,aiW)}" height="${bw}" rx="2" fill="${C.orange}"
                onClick=${onClick?()=>onClick(label):null} />
              <text x="${ml-6}" y="${y+bw+gap/2}" text-anchor="end" dominant-baseline="middle"
                fill="${C.copy}" font-size="10" font-weight="500">${short}</text>`; })}
        </svg>`;
    }

    function LineChart({ data }) {
      const W=340, H=200, ml=36, mr=16, mt=15, mb=26;
      const w=W-ml-mr, h=H-mt-mb;
      const mx=Math.max(...data.map(d=>Math.max(d.base,d.adj)));
      const pt=(i,v)=>[ml+i/(data.length-1)*w, mt+h*(1-v/mx)];
      const basePts=data.map((d,i)=>pt(i,d.base)), adjPts=data.map((d,i)=>pt(i,d.adj));
      const areaPath="M"+basePts.map(p=>p.join(",")).join("L")+
        "L"+basePts[basePts.length-1][0]+","+(mt+h)+"L"+basePts[0][0]+","+(mt+h)+"Z";
      return html`
        <svg viewBox="0 0 ${W} ${H}" class="chart-svg line-chart">
          <defs><linearGradient id="capGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="${C.ww1}" stop-opacity="0.3" />
            <stop offset="100%" stop-color="${C.ww1}" stop-opacity="0" />
          </linearGradient></defs>
          ${[0,5,10,15].filter(v=>v<=mx).map(v => { const y=mt+h*(1-v/mx); return html`
            <line x1="${ml}" y1="${y}" x2="${W-mr}" y2="${y}" stroke="${C.border}" stroke-width="0.5" stroke-dasharray="3 3" />
            <text x="${ml-5}" y="${y}" text-anchor="end" dominant-baseline="middle" fill="${C.dim}" font-size="9">${v}</text>`; })}
          ${[0,5,10,15,20,25].map(v => { const x=ml+v/25*w; return html`
            <text x="${x}" y="${H-mb+13}" text-anchor="middle" fill="${C.dim}" font-size="9">${v}</text>`; })}
          <path d="${areaPath}" fill="url(#capGrad)" />
          <polyline points="${basePts.map(p=>p.join(",")).join(" ")}" fill="none" stroke="${C.ww1}" stroke-width="2" />
          <polyline points="${adjPts.map(p=>p.join(",")).join(" ")}" fill="none" stroke="${C.red}" stroke-width="2" stroke-dasharray="6 3" />
          <rect x="${W-mr-110}" y="${mt}" width="106" height="32" rx="4" fill="${C.cardBg}" stroke="${C.border}" stroke-width="0.5" />
          <line x1="${W-mr-102}" y1="${mt+10}" x2="${W-mr-86}" y2="${mt+10}" stroke="${C.ww1}" stroke-width="2" />
          <text x="${W-mr-82}" y="${mt+10}" dominant-baseline="middle" fill="${C.dim}" font-size="8">Base CAP</text>
          <line x1="${W-mr-102}" y1="${mt+22}" x2="${W-mr-86}" y2="${mt+22}" stroke="${C.red}" stroke-width="2" stroke-dasharray="4 2" />
          <text x="${W-mr-82}" y="${mt+22}" dominant-baseline="middle" fill="${C.dim}" font-size="8">AI+BM Adj</text>
        </svg>`;
    }

    function ScatterPlot({ data }) {
      const W=360, H=320, ml=42, mr=16, mt=16, mb=36;
      const w=W-ml-mr, h=H-mt-mb;
      const sc=(v,min,max)=>(v-min)/(max-min);
      return html`
        <svg viewBox="0 0 ${W} ${H}" class="chart-svg scatter-chart">
          ${[1,2,3,4,5].map(v => {
            const x=ml+sc(v,0.5,5)*w, y=mt+(1-sc(v,0.5,5))*h;
            return html`
              <line x1="${x}" y1="${mt}" x2="${x}" y2="${mt+h}" stroke="${C.border}" stroke-width="0.5" />
              <line x1="${ml}" y1="${y}" x2="${ml+w}" y2="${y}" stroke="${C.border}" stroke-width="0.5" />
              <text x="${x}" y="${H-mb+13}" text-anchor="middle" fill="${C.dim}" font-size="9">${v}</text>
              <text x="${ml-6}" y="${y}" text-anchor="end" dominant-baseline="middle" fill="${C.dim}" font-size="9">${v}</text>`; })}
          <line x1="${ml+sc(2.5,0.5,5)*w}" y1="${mt}" x2="${ml+sc(2.5,0.5,5)*w}" y2="${mt+h}"
            stroke="${C.dim}" stroke-width="0.8" stroke-dasharray="4 3" opacity="0.5" />
          <line x1="${ml}" y1="${mt+(1-sc(2.5,0.5,5))*h}" x2="${ml+w}" y2="${mt+(1-sc(2.5,0.5,5))*h}"
            stroke="${C.dim}" stroke-width="0.8" stroke-dasharray="4 3" opacity="0.5" />
          <text x="${ml+8}" y="${mt+12}" fill="${C.green}" font-size="7" opacity="0.6">STRONG MOAT / LOW RISK</text>
          <text x="${ml+w-4}" y="${mt+h-6}" fill="${C.red}" font-size="7" text-anchor="end" opacity="0.6">WEAK MOAT / HIGH RISK</text>
          ${data.map(d => {
            const x=ml+sc(d.ai,0.5,5)*w, y=mt+(1-sc(d.ms,0.5,5))*h;
            const tc=TIER_COLORS[d.t]||C.dim;
            return html`
              <circle cx="${x}" cy="${y}" r="8" fill="${tc}" fill-opacity="0.85" stroke="#fff" stroke-width="1.5" />
              <text x="${x}" y="${y-12}" text-anchor="middle" fill="${C.copy}" font-size="8" font-weight="700">${d.tk}</text>`; })}
          <text x="${ml+w/2}" y="${H-4}" text-anchor="middle" fill="${C.dim}" font-size="10">AI Disruption Risk â†’</text>
          <text x="12" y="${mt+h/2}" text-anchor="middle" dominant-baseline="middle" fill="${C.dim}" font-size="10"
            transform="rotate(-90,12,${mt+h/2})">â† Moat Strength</text>
        </svg>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SECTOR DETAIL + SUBSECTOR DRILL-DOWN (Chunk 2+3)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function SectorDetail({ sector, data, raw, onBack }) {
      const tc = TIER_COLORS[data.tier] || C.dim;
      const nc = data.netScore>1?C.green:data.netScore>0?"#6bbd5b":data.netScore>-0.5?C.yellow:C.red;
      const moatData = [{d:"SC",s:raw.sc},{d:"NE",s:raw.ne},{d:"IA",s:raw.ia},{d:"CA",s:raw.ca},{d:"ES",s:raw.es}];
      const aiData = [{d:"LS",s:raw.ls},{d:"VCD",s:raw.vcd},{d:"DME",s:raw.dme},{d:"ANC",s:raw.anc},{d:"CIR",s:raw.cir}];
      const capData = [];
      for (let yr=0; yr<=25; yr++) capData.push({ year:yr, base:Math.max(0,data.baseCap-yr*0.4), adj:Math.max(0,data.adjCap-yr*0.35) });

      // Subsector data
      const subs = useMemo(() => {
        return (SUBSEC[sector] || []).map(d => {
          const m = calcMoat(d), a = calcAI(d);
          return { ...d, moat: +m.toFixed(2), aiRisk: +a.toFixed(2), net: +(m-a).toFixed(2) };
        }).sort((a,b) => b.net - a.net);
      }, [sector]);

      return html`
        <div class="sector-detail">
          <button class="back-btn" onClick=${onBack}>â† Sectors</button>
          <div class="detail-header" style="border-left: 4px solid ${tc}">
            <div class="detail-title-row">
              <h2 class="detail-title">${sector}</h2>
              <span class="tier-badge-lg" style="background: ${tc}20; color: ${tc}">${data.tier}</span>
            </div>
            <div class="detail-net" style="color: ${nc}">Net: ${data.netScore>0?"+":""}${data.netScore.toFixed(2)}</div>
          </div>

          <div class="score-pills">
            <div class="pill"><span class="pill-label">Moat</span>
              <span class="pill-value" style="color: ${C.ww1}">${data.moatScore.toFixed(2)}</span></div>
            <div class="pill"><span class="pill-label">AI Risk</span>
              <span class="pill-value" style="color: ${C.orange}">${data.aiScore.toFixed(2)}</span></div>
            <div class="pill"><span class="pill-label">Adj CAP</span>
              <span class="pill-value">${data.adjCap}y</span></div>
            <div class="pill"><span class="pill-label">Haircut</span>
              <span class="pill-value" style="color: ${C.red}">-${data.haircut}%</span></div>
            <div class="pill"><span class="pill-label">AI Prem</span>
              <span class="pill-value" style="color: ${C.red}">+${data.aiPremBps}bp</span></div>
          </div>

          <div class="radar-pair">
            <div class="radar-col">
              <div class="radar-label">Moat Sources</div>
              <${RadarChart} data=${moatData} size=${200} color=${C.ww1} />
            </div>
            <div class="radar-col">
              <div class="radar-label">AI Risk Dimensions</div>
              <${RadarChart} data=${aiData} size=${200} color=${C.orange} />
            </div>
          </div>

          <div class="detail-section">
            <h3 class="section-title">Moat Factor Scores</h3>
            <div class="factor-grid">
              ${moatData.map(f => html`
                <div class="factor-item">
                  <span class="factor-abbr">${f.d}</span>
                  <span class="factor-name">${MOAT_LABELS[f.d.toLowerCase()]||f.d}</span>
                  <span class="factor-score" style="color: ${f.s>=4?C.green:f.s>=3?C.ww1:C.dim}">${f.s}/5</span>
                </div>`)}
            </div>
          </div>

          <div class="detail-section">
            <h3 class="section-title" style="color: ${C.orange}">AI Disruption Scores</h3>
            <${HBarChart} data=${aiData.map(f=>({d:AI_LABELS[f.d.toLowerCase()]||f.d, s:f.s}))}
              color=${v=>v>=4?C.red:v>=3?C.orange:C.green} />
          </div>

          <div class="detail-section">
            <h3 class="section-title">Competitive Advantage Period</h3>
            <p class="section-sub">Base ${data.baseCap}yr â†’ AI-adjusted ${data.adjCap}yr (${Math.round((1-data.adjCap/data.baseCap)*100)}% compression)</p>
            <${LineChart} data=${capData} />
          </div>

          ${subs.length > 0 && html`
            <div class="detail-section">
              <h3 class="section-title">Subsectors (${subs.length})</h3>
              <p class="section-sub">Differentiated AI disruption risk within ${sector}</p>
              <div class="sub-table-wrap">
                <table class="data-table sub-table">
                  <thead><tr>
                    <th style="text-align:left">Subsector</th>
                    <th>Moat</th><th>AI</th><th>Net</th>
                  </tr></thead>
                  <tbody>
                    ${subs.map(d => {
                      const snc = d.net>1?C.green:d.net>0?"#6bbd5b":d.net>-0.5?C.yellow:C.red;
                      return html`<tr>
                        <td style="font-weight:600;font-size:0.75rem">${d.name}<br/>
                          <span style="color:${C.dim};font-size:0.65rem;font-weight:400">${d.examples}</span></td>
                        <td style="text-align:center;color:${d.moat>=3.5?C.green:d.moat>=2.5?C.ww1:C.orange};font-weight:700">${d.moat}</td>
                        <td style="text-align:center;color:${d.aiRisk>=3.5?C.red:d.aiRisk>=2.5?C.orange:C.green};font-weight:700">${d.aiRisk}</td>
                        <td style="text-align:center;color:${snc};font-weight:800;font-size:0.9rem">${d.net>0?"+":""}${d.net}</td>
                      </tr>`;
                    })}
                  </tbody>
                </table>
              </div>
            </div>

            ${subs.map(d => {
              const snc = d.net>1?C.green:d.net>0?"#6bbd5b":d.net>-0.5?C.yellow:C.red;
              return html`
                <div class="sub-card" style="border-left: 3px solid ${snc}">
                  <div class="sub-card-header">
                    <span class="sub-card-name">${d.name}</span>
                    <span class="sub-card-net" style="color:${snc}">${d.net>0?"+":""}${d.net}</span>
                  </div>
                  <div class="sub-card-examples">${d.examples}</div>
                  <div class="radar-pair" style="margin-bottom:8px">
                    <div class="radar-col">
                      <div class="radar-label">Moat</div>
                      <${RadarChart} data=${[{d:"SC",s:d.sc},{d:"NE",s:d.ne},{d:"IA",s:d.ia},{d:"CA",s:d.ca},{d:"ES",s:d.es}]}
                        size=${160} color=${C.ww1} />
                    </div>
                    <div class="radar-col">
                      <div class="radar-label">AI Risk</div>
                      <${RadarChart} data=${[{d:"LS",s:d.ls},{d:"VCD",s:d.vcd},{d:"DME",s:d.dme},{d:"ANC",s:d.anc},{d:"CIR",s:d.cir}]}
                        size=${160} color=${C.orange} />
                    </div>
                  </div>
                  <div class="sub-card-footer">
                    <span style="color:${C.ww1}">Moat: ${d.moat}</span>
                    <span style="color:${C.orange}">AI: ${d.aiRisk}</span>
                  </div>
                </div>`;
            })}
          `}
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SECTOR CARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function SectorCard({ sector, data, onClick }) {
      const tc = TIER_COLORS[data.tier] || C.dim;
      const nc = data.netScore>1?C.green:data.netScore>0?"#6bbd5b":data.netScore>-0.5?C.yellow:C.red;
      const subCount = SUBSEC[sector]?.length || 0;
      return html`
        <div class="sector-card" style="border-left: 3px solid ${tc}" onClick=${onClick}>
          <div class="sector-header">
            <span class="sector-name">${sector}</span>
            <span class="tier-badge" style="background: ${tc}20; color: ${tc}">${data.tier}</span>
          </div>
          <div class="sector-scores">
            <div class="score-item"><span class="score-label">Moat</span>
              <span class="score-value" style="color: ${C.ww1}">${data.moatScore.toFixed(1)}</span></div>
            <div class="score-item"><span class="score-label">AI Risk</span>
              <span class="score-value" style="color: ${C.orange}">${data.aiScore.toFixed(1)}</span></div>
            <div class="score-item"><span class="score-label">Net</span>
              <span class="score-value" style="color: ${nc}">${data.netScore>0?"+":""}${data.netScore.toFixed(1)}</span></div>
            <div class="score-item"><span class="score-label">Haircut</span>
              <span class="score-value" style="color: ${C.red}">-${data.haircut}%</span></div>
          </div>
          ${subCount > 0 && html`<div class="card-sub-count">${subCount} subsectors â€º</div>`}
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WIKI TAB (Chunk 3)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function WikiTab() {
      return html`
        <div class="wiki-content">
          <h2 class="wiki-h1">ğŸ° AI Moat Risk Analyzer</h2>
          <p class="wiki-sub">Westwood Holdings Group Â· Superbad Investment Group</p>

          <div class="wiki-callout">
            <strong>Key Output:</strong> An AI-adjusted justified P/E ratio reflecting
            potential erosion of competitive advantages from AI disruption, expressed as
            a "haircut" percentage vs the base justified P/E.
          </div>

          <h3 class="wiki-h2">Moat Framework (Morningstar 5-Source)</h3>
          <p>Each company's moat is scored 1â€“5 across five dimensions, then weighted:</p>
          <table class="data-table wiki-table">
            <thead><tr><th>Source</th><th>Wt</th><th>What It Measures</th></tr></thead>
            <tbody>
              <tr><td><strong>SC</strong> Switching Costs</td><td>25%</td><td>Cost/pain of changing to a competitor</td></tr>
              <tr><td><strong>NE</strong> Network Effects</td><td>20%</td><td>Product value grows with more users</td></tr>
              <tr><td><strong>IA</strong> Intangible Assets</td><td>25%</td><td>Patents, brands, licenses, proprietary data</td></tr>
              <tr><td><strong>CA</strong> Cost Advantage</td><td>15%</td><td>Structural ability to produce at lower cost</td></tr>
              <tr><td><strong>ES</strong> Efficient Scale</td><td>15%</td><td>Market only supports limited competitors</td></tr>
            </tbody>
          </table>
          <div class="wiki-formula">Moat = SCÃ—0.25 + NEÃ—0.20 + IAÃ—0.25 + CAÃ—0.15 + ESÃ—0.15</div>

          <h3 class="wiki-h2">AI Disruption Risk (5-Dimension)</h3>
          <p>Five dimensions scored 1â€“5 (5 = highest risk):</p>
          <table class="data-table wiki-table">
            <thead><tr><th>Dimension</th><th>Wt</th><th>What It Measures</th></tr></thead>
            <tbody>
              <tr><td><strong>LS</strong> Labor Substitution</td><td>25%</td><td>Workforce replacement by AI</td></tr>
              <tr><td><strong>VCD</strong> Value Chain Disintermed.</td><td>25%</td><td>AI removes the middleman role</td></tr>
              <tr><td><strong>DME</strong> Data Moat Erosion</td><td>15%</td><td>AI commoditizes proprietary data</td></tr>
              <tr><td><strong>ANC</strong> AI-Native Competition</td><td>20%</td><td>Born-AI startups at fraction of cost</td></tr>
              <tr><td><strong>CIR</strong> Commodity Intelligence</td><td>15%</td><td>Core "intelligence" becomes commodity</td></tr>
            </tbody>
          </table>
          <div class="wiki-formula">AI Risk = LSÃ—0.25 + VCDÃ—0.25 + DMEÃ—0.15 + ANCÃ—0.20 + CIRÃ—0.15</div>

          <h3 class="wiki-h2">Competitive Advantage Period (CAP)</h3>
          <p>How many years a company sustains above-market returns. AI risk compresses this:</p>
          <table class="data-table wiki-table">
            <thead><tr><th>Moat Score</th><th>Base CAP</th><th>Interpretation</th></tr></thead>
            <tbody>
              <tr><td>4.0+</td><td>22yr</td><td>Wide moat â€” exceptional</td></tr>
              <tr><td>3.5â€“4.0</td><td>18yr</td><td>Strong moat</td></tr>
              <tr><td>3.0â€“3.5</td><td>14yr</td><td>Moderate moat</td></tr>
              <tr><td>2.5â€“3.0</td><td>10yr</td><td>Narrow moat</td></tr>
              <tr><td>2.0â€“2.5</td><td>7yr</td><td>Weak moat</td></tr>
              <tr><td>Below 2.0</td><td>4yr</td><td>No meaningful moat</td></tr>
            </tbody>
          </table>
          <div class="wiki-formula">Adj CAP = Base Ã— (1 âˆ’ max(0, (AIâˆ’1.5) Ã— 0.15) âˆ’ BMÃ—0.05), min 2yr</div>

          <h3 class="wiki-h2">WACC Premium (Damodaran)</h3>
          <p>AI adds a risk premium to cost of capital:</p>
          <table class="data-table wiki-table">
            <thead><tr><th>AI Risk</th><th>Premium</th></tr></thead>
            <tbody>
              <tr><td>Below 2.0</td><td>0bp</td></tr>
              <tr><td>2.0â€“2.5</td><td>+50bp</td></tr>
              <tr><td>2.5â€“3.0</td><td>+100bp</td></tr>
              <tr><td>3.0â€“3.5</td><td>+150bp</td></tr>
              <tr><td>3.5â€“4.0</td><td>+225bp</td></tr>
              <tr><td>4.0+</td><td>+300bp</td></tr>
            </tbody>
          </table>

          <h3 class="wiki-h2">The "Haircut"</h3>
          <p>The central output â€” how much less you should pay for earnings given AI risk:</p>
          <div class="wiki-formula">Haircut % = (Base P/E âˆ’ AI-Adjusted P/E) / Base P/E Ã— 100</div>
          <p><strong>Step 1:</strong> Compute base P/E using base WACC + full CAP (no AI).</p>
          <p><strong>Step 2:</strong> Recompute with AI WACC premium + compressed CAP.</p>
          <p><strong>Step 3:</strong> The difference is the haircut percentage.</p>
          <p>Driven by CAP compression (shorter premium-earnings window) and WACC expansion
          (future cash flows worth less today).</p>

          <h3 class="wiki-h2">Risk Tiers</h3>
          <table class="data-table wiki-table">
            <thead><tr><th>Net Range</th><th>Tier</th></tr></thead>
            <tbody>
              <tr><td>Above +1.5</td><td style="color:${C.green};font-weight:700">LOW</td></tr>
              <tr><td>+0.5 to +1.5</td><td style="color:${C.greenLt};font-weight:700">LOW-MEDIUM</td></tr>
              <tr><td>âˆ’0.5 to +0.5</td><td style="color:${C.yellow};font-weight:700">MEDIUM</td></tr>
              <tr><td>âˆ’2.0 to âˆ’0.5</td><td style="color:${C.orange};font-weight:700">HIGH</td></tr>
              <tr><td>Below âˆ’2.0</td><td style="color:${C.red};font-weight:700">CRITICAL</td></tr>
            </tbody>
          </table>

          <h3 class="wiki-h2">Data Sources</h3>
          <p><strong>Yahoo Finance</strong> â€” Free live market data (P/E, EPS, margins, beta, etc.)</p>
          <p><strong>FMP</strong> â€” Optional fallback for SEC-derived financials (250 calls/day free tier)</p>
          <p><strong>AI Provider</strong> â€” Claude/GPT-4o/Gemini for company-specific moat scoring (~$0.01-0.03/company)</p>
          <p><strong>Sector Defaults</strong> â€” Built-in GICS sector scores (no API needed)</p>

          <p class="wiki-footer">Analysis and Build by Adrian Helfert Â· Westwood Holdings Group Â·
          Superbad Investment Group Â· For Internal Use Only Â· Integrity. Reliability. Results.</p>
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SUMMARY PILLS (Chunk 3)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function SummaryPills({ sorted, subCount }) {
      const best = sorted[sorted.length - 1];
      const worst = sorted[0];
      return html`
        <div class="summary-pills">
          <div class="sum-pill"><span class="sum-label">Sectors</span><span class="sum-val" style="color:${C.ww1}">${sorted.length}</span></div>
          <div class="sum-pill"><span class="sum-label">Subsectors</span><span class="sum-val" style="color:${C.accent}">${subCount}</span></div>
          <div class="sum-pill"><span class="sum-label">Strongest</span><span class="sum-val" style="color:${C.green}">${best?.[0]?.split(" ")[0]}</span></div>
          <div class="sum-pill"><span class="sum-label">Most at Risk</span><span class="sum-val" style="color:${C.red}">${worst?.[0]?.split(" ")[0]}</span></div>
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CHUNK 5: PM OVERRIDES EDITOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function OverrideEditor({overrides, onSave}){
      const [editSector, setEditSector] = useState(null);
      const [editScores, setEditScores] = useState({});
      const factors = [
        {k:"sc",l:"Switching Costs",cat:"moat"},{k:"ne",l:"Network Effects",cat:"moat"},
        {k:"ia",l:"Intangible Assets",cat:"moat"},{k:"ca",l:"Cost Advantage",cat:"moat"},
        {k:"es",l:"Efficient Scale",cat:"moat"},{k:"ls",l:"Labor Substitution",cat:"ai"},
        {k:"vcd",l:"Disintermediation",cat:"ai"},{k:"dme",l:"Data/Model Erosion",cat:"ai"},
        {k:"anc",l:"AI-Native Competition",cat:"ai"},{k:"cir",l:"Commodity Intel Risk",cat:"ai"},
      ];
      const sectors = Object.keys(SECTOR_DB).sort();
      const hasOverrides = s => Object.keys(overrides.sectors?.[s]||{}).length > 0;

      const startEdit = (s) => {
        const base = SECTOR_DB[s];
        const ov = overrides.sectors?.[s] || {};
        setEditScores({...base, ...ov});
        setEditSector(s);
      };
      const saveEdit = () => {
        const base = SECTOR_DB[editSector];
        const diff = {};
        for (const f of factors) {
          if (editScores[f.k] !== base[f.k]) diff[f.k] = editScores[f.k];
        }
        const newOv = {...overrides, sectors: {...overrides.sectors}};
        if (Object.keys(diff).length > 0) newOv.sectors[editSector] = diff;
        else delete newOv.sectors[editSector];
        onSave(newOv);
        setEditSector(null);
      };
      const resetEdit = () => {
        const newOv = {...overrides, sectors: {...overrides.sectors}};
        delete newOv.sectors[editSector];
        onSave(newOv);
        setEditScores({...SECTOR_DB[editSector]});
      };

      if (editSector) {
        return html`<div>
          <button class="back-btn" onClick=${()=>setEditSector(null)}>â† Back</button>
          <div style="font-weight:700;font-size:0.9rem;color:${C.accent};margin-bottom:12px">${editSector}</div>
          <div style="display:flex;flex-direction:column;gap:4px">
            ${factors.map(f => {
              const base = SECTOR_DB[editSector][f.k];
              const cur = editScores[f.k] || base;
              const changed = cur !== base;
              return html`<div class="override-row">
                <div class="override-label" style="color:${f.cat==='ai'?C.orange:C.accent}">
                  ${f.l} ${changed && html`<span style="color:${C.yellow};font-size:0.65rem"> (was ${base})</span>`}
                </div>
                <div class="override-btns">
                  ${[1,2,3,4,5].map(v => html`<button class="score-btn${cur===v?' active':''}"
                    style="background:${cur===v?(f.cat==='ai'?(v>=4?C.red:v>=3?C.orange:C.green):(v>=4?C.green:v>=3?C.yellow:C.red))+'30':'transparent'};color:${cur===v?C.text:C.dim};border-color:${cur===v?(f.cat==='ai'?(v>=4?C.red:v>=3?C.orange:C.green):(v>=4?C.green:v>=3?C.yellow:C.red)):C.border}"
                    onClick=${()=>setEditScores(s=>({...s,[f.k]:v}))}>${v}</button>`)}
                </div>
              </div>`;
            })}
          </div>
          <div style="display:flex;gap:8px;margin-top:14px">
            <button class="btn btn-primary" style="flex:1" onClick=${saveEdit}>Save Overrides</button>
            <button class="btn btn-secondary" onClick=${resetEdit}>Reset</button>
          </div>
        </div>`;
      }

      return html`<div>
        <div style="display:flex;flex-direction:column;gap:4px">
          ${sectors.map(s => html`<div class="override-sector-row" onClick=${()=>startEdit(s)}>
            <span style="font-size:0.82rem;font-weight:${hasOverrides(s)?700:500};color:${hasOverrides(s)?C.accent:C.text}">${s}</span>
            <span style="font-size:0.72rem;color:${hasOverrides(s)?C.yellow:C.dim}">${hasOverrides(s)?"âœ Modified":"Default"}</span>
          </div>`)}
        </div>
      </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CHUNK 5: PM NOTES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function NotesEditor(){
      const [notes, setNotes] = useState(()=>{
        try{return JSON.parse(localStorage.getItem("moat_pm_notes")||"{}");} catch(e){return{};}
      });
      const [editTicker, setEditTicker] = useState("");
      const [editText, setEditText] = useState("");
      const [addMode, setAddMode] = useState(false);

      const save = (tk, text) => {
        const n = {...notes};
        if (text.trim()) n[tk.toUpperCase()] = text.trim();
        else delete n[tk.toUpperCase()];
        setNotes(n);
        localStorage.setItem("moat_pm_notes", JSON.stringify(n));
      };
      const tickers = Object.keys(notes).sort();

      return html`<div>
        ${tickers.map(tk => html`<div class="note-item">
          <div class="note-header">
            <span style="font-family:monospace;font-weight:700;color:${C.accent}">${tk}</span>
            <button class="note-del" onClick=${()=>save(tk,"")}>âœ•</button>
          </div>
          <textarea class="note-text" value=${notes[tk]}
            onInput=${e=>save(tk,e.target.value)} rows="2" />
        </div>`)}
        ${addMode ? html`<div style="margin-top:8px">
          <div class="input-row">
            <input class="input-field" placeholder="AAPL" value=${editTicker}
              onInput=${e=>setEditTicker(e.target.value)} style="width:80px;flex:none;text-transform:uppercase" />
            <textarea class="input-field" placeholder="Your notesâ€¦" value=${editText}
              onInput=${e=>setEditText(e.target.value)} rows="2" style="flex:1" />
          </div>
          <div class="input-row" style="margin-top:4px">
            <button class="btn btn-primary" style="flex:1" onClick=${()=>{
              if(editTicker.trim()){save(editTicker,editText);setEditTicker("");setEditText("");setAddMode(false);}
            }}>Save Note</button>
            <button class="btn btn-secondary" onClick=${()=>setAddMode(false)}>Cancel</button>
          </div>
        </div>`
        :html`<button class="btn btn-secondary" style="width:100%;margin-top:8px" onClick=${()=>setAddMode(true)}>+ Add Note</button>`}
      </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CHUNK 5: EXPORT FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function exportPortfolio(portfolio){
      const fmt=(v,d=1)=>v!=null?Number(v).toFixed(d):"â€”";
      const headers = ["Ticker","Name","Sector","Moat","AI Risk","BM Risk","Net","Tier","CAP","Adj CAP","AI Prem","Base P/E","Adj P/E","Haircut%","Sec Hcut%","ROIC%"];
      const rows = portfolio.map(d=>[
        d.ticker, d.fmp?.name||"", d.fmp?.sector||"",
        fmt(d.comp.ms,2), fmt(d.comp.ai,2), fmt(d.comp.bmr,1),
        fmt(d.comp.net,2), d.comp.t, d.comp.bCap, d.comp.aCap,
        "+"+d.comp.bp, fmt(d.comp.bPE), fmt(d.comp.aPE),
        "-"+fmt(d.comp.haircut), "-"+fmt(d.comp.secHaircut),
        d.fmp?.roic?(d.fmp.roic*100).toFixed(1):""
      ].join("\t"));
      const tsv = headers.join("\t") + "\n" + rows.join("\n");
      navigator.clipboard?.writeText(tsv).then(()=>alert("Portfolio copied to clipboard (TSV â€” paste into Excel)")).catch(()=>fallbackCopy(tsv));
    }

    function exportTicker(r){
      const fmt=(v,d=1)=>v!=null?Number(v).toFixed(d):"â€”";
      const lines = [
        `${r.ticker} â€” ${r.fmp?.name}`,
        `Sector: ${r.fmp?.sector}  |  ${r.moat?.msRating} Moat  |  Tier: ${r.comp.t}`,
        `Moat: ${fmt(r.comp.ms,2)}  AI Risk: ${fmt(r.comp.ai,2)}  BM Risk: ${fmt(r.comp.bmr,1)}  Net: ${fmt(r.comp.net,2)}`,
        `CAP: ${r.comp.bCap}â†’${r.comp.aCap}yr  AI Prem: +${r.comp.bp}bp`,
        `Base P/E: ${fmt(r.comp.bPE)}x  Adj P/E: ${fmt(r.comp.aPE)}x  Haircut: -${fmt(r.comp.haircut)}%`,
        `Price: $${fmt(r.fmp?.price,2)}  Mkt Cap: ${r.fmp?.mktCap?'$'+(r.fmp.mktCap/1e9).toFixed(1)+'B':'â€”'}`,
        `\nMoat: ${r.moat?.moatNarrative||''}`,
        `Vulnerability: ${r.moat?.keyVulnerabilities||''}`,
        r.bmRisk?.queenerTier&&r.bmRisk.queenerTier!=="Unknown"?`WR Tier: ${r.bmRisk.queenerTier} â€” ${r.bmRisk.queenerDetail||''}`:'',
      ].filter(Boolean).join("\n");
      navigator.clipboard?.writeText(lines).then(()=>alert("Ticker detail copied")).catch(()=>fallbackCopy(lines));
    }

    function exportOverrides(overrides){
      const json = JSON.stringify(overrides, null, 2);
      navigator.clipboard?.writeText(json).then(()=>alert("Overrides JSON copied")).catch(()=>fallbackCopy(json));
    }

    function fallbackCopy(text){
      const ta = document.createElement("textarea");
      ta.value = text; ta.style.cssText = "position:fixed;opacity:0";
      document.body.appendChild(ta); ta.select();
      document.execCommand("copy"); document.body.removeChild(ta);
      alert("Copied to clipboard");
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // APP COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function App() {
      const [overrides, setOverrides] = useState(() => loadOverrides());
      const [activeTab, setActiveTab] = useState("analyze");
      const [selectedSector, setSelectedSector] = useState(null);
      const sComp = useMemo(() => computeSComp(overrides), [overrides]);
      const sorted = useMemo(() => Object.entries(sComp).sort((a,b) => a[1].netScore - b[1].netScore), [sComp]);
      const subComp = useMemo(() => computeSubComp(), []);
      const subCount = subComp.length;

      const chartData = useMemo(() =>
        sorted.map(([name,d]) => ({ name, net:d.netScore, moatScore:d.moatScore, aiScore:d.aiScore })), [sorted]);
      const scatterData = useMemo(() =>
        sorted.map(([name,d]) => ({ tk:name.split(" ")[0], ms:d.moatScore, ai:d.aiScore, t:d.tier, net:d.netScore })), [sorted]);

      // â”€â”€ Analyze state â”€â”€
      const [ticker, setTicker] = useState("");
      const [tickerList, setTickerList] = useState("");
      const [mode, setMode] = useState("single");
      const [loading, setLoading] = useState(false);
      const [progress, setProgress] = useState("");
      const [error, setError] = useState(null);
      const [result, setResult] = useState(null);
      const [portfolio, setPortfolio] = useState([]);
      const [selected, setSelected] = useState(null);
      const [detailTab, setDetailTab] = useState(0);
      const [portTab, setPortTab] = useState(0);
      const [showSettings, setShowSettings] = useState(false);
      const [fmpKey, setFmpKey] = useState(()=>localStorage.getItem("moat_fmp_key")||"");
      const [llmKey, setLlmKey] = useState(()=>localStorage.getItem("moat_llm_key")||"");
      const [llmProvider, setLlmProvider] = useState(()=>localStorage.getItem("moat_llm_provider")||"claude");
      const fileRef = useRef(null);

      // Persist keys
      useEffect(()=>{localStorage.setItem("moat_fmp_key",fmpKey);},[fmpKey]);
      useEffect(()=>{localStorage.setItem("moat_llm_key",llmKey);},[llmKey]);
      useEffect(()=>{localStorage.setItem("moat_llm_provider",llmProvider);},[llmProvider]);

      const analyzeSingle = useCallback(async(t)=>{
        const tk=(t||ticker).trim().toUpperCase();
        if(!tk){setError("Enter ticker");return null;}
        const st={data:"â€¦",moat:"â€¦"};
        setProgress(tk+": Fetching financialsâ€¦");
        let fmp;
        try{
          fmp=await fetchFinancials(tk,fmpKey);
          const src=fmp._src||"none";
          st.data=fmp._ok?(src==="yahoo+fmp"?"âœ“ Yahoo + FMP":src.startsWith("yahoo")?"âœ“ Yahoo":"âœ“ FMP"):"âš  "+fmp._errs.join("; ");
        }catch(e){
          st.data="âœ— "+e.message;
          fmp={name:tk,ticker:tk,sector:"Unknown",industry:"Unknown",price:0,mktCap:0,beta:1,peRatio:0,roic:0,roe:0,grossMargin:0,operatingMargin:0,netMargin:0,fcfYield:0,debtToEquity:0,dividendYield:0,evToEbitda:0,pbRatio:0,rdToRev:0,avgRevGrowth:0.05,_ok:false,_errs:[e.message],_src:"none"};
        }
        const finFailed=!fmp._ok||!fmp.price;
        setProgress(tk+": Scoring moatâ€¦");
        let mb;
        if(llmKey){
          const provName=LLM_PROVIDERS[llmProvider]?.name||llmProvider;
          try{
            mb=await fetchMoatBM(llmProvider,llmKey,tk,fmp.sector,fmp.industry,finFailed);
            if(!mb?.sc)throw new Error("no scores");
            st.moat="âœ“ "+provName;
            if(finFailed&&mb.fin){
              const f=mb.fin;
              fmp={...fmp,name:f.name||tk,ticker:tk,sector:f.sector||"Unknown",industry:f.industry||"Unknown",
                price:f.price||0,mktCap:f.mktCap||0,beta:f.beta||1,peRatio:f.peRatio||0,
                roe:f.roe||0,roic:f.roic||0,grossMargin:f.grossMargin||0,operatingMargin:f.operatingMargin||0,
                netMargin:f.netMargin||0,fcfYield:f.fcfYield||0,debtToEquity:f.debtToEquity||0,
                dividendYield:f.dividendYield||0,evToEbitda:f.evToEbitda||0,pbRatio:f.pbRatio||0,
                rdToRev:f.rdToRev||0,avgRevGrowth:f.avgRevGrowth||0.05,_ok:true,_errs:[],_src:"ai-estimated"};
              st.data="âœ“ AI-estimated ("+provName+")";
            }
          }catch(e){st.moat="âœ— "+provName+": "+e.message.substring(0,60);mb=sectorDefault(fmp.sector);}
        }else{mb=sectorDefault(fmp.sector);st.moat="sector defaults";}
        const moat={msRating:mb.msRating,sc:mb.sc,ne:mb.ne,ia:mb.ia,ca:mb.ca,es:mb.es,ls:mb.ls,vcd:mb.vcd,dme:mb.dme,anc:mb.anc,cir:mb.cir,primaryMoatSource:mb.primaryMoatSource,keyVulnerabilities:mb.keyVulnerabilities,moatNarrative:mb.moatNarrative};
        const bmRisk={systemType:mb.systemType,capitalStructure:mb.capitalStructure,valueDelivery:mb.valueDelivery,buyVsBuildRisk:mb.buyVsBuildRisk,jtbdDensity:mb.jtbdDensity,moatDecayRate:mb.moatDecayRate,verticalVsHorizontal:mb.verticalVsHorizontal,marginStructure:mb.marginStructure,queenerTier:mb.queenerTier,queenerDetail:mb.queenerDetail,compositeRisk:mb.compositeRisk};
        return{fmp,moat,comp:computeAll(fmp,moat,bmRisk),bmRisk,ticker:tk,st};
      },[ticker,fmpKey,llmKey,llmProvider]);

      const handleAnalyze = useCallback(async()=>{
        setLoading(true);setError(null);setResult(null);setPortfolio([]);setSelected(null);
        try{
          if(mode==="single"){
            const r=await analyzeSingle();
            if(r){setResult(r);setDetailTab(0);}
          }else{
            const tks=tickerList.split(/[,\s\n]+/).map(t=>t.trim().toUpperCase()).filter(Boolean);
            if(!tks.length){setError("Enter tickers");return;}
            const res=[];
            for(let i=0;i<tks.length;i++){
              try{setProgress(tks[i]+" ("+(i+1)+"/"+tks.length+")â€¦");
                const r=await analyzeSingle(tks[i]);if(r)res.push(r);
              }catch(e){}
              if(i<tks.length-1)await new Promise(r=>setTimeout(r,500));
            }
            setPortfolio(res);setPortTab(0);
          }
        }catch(e){setError(e.message);}finally{setLoading(false);setProgress("");}
      },[mode,ticker,tickerList,analyzeSingle]);

      const handleFileUpload = useCallback((e)=>{
        const file=e.target.files?.[0];if(!file)return;
        const reader=new FileReader();
        reader.onload=(ev)=>{
          const tickers=parseCSV(ev.target.result);
          if(tickers.length>0){setTickerList(tickers.join(", "));setMode("portfolio");}
          else{setError("No valid tickers found");}
        };
        reader.readAsText(file);e.target.value="";
      },[]);

      const r = selected || result;

      return html`
        <div class="app">
          <header class="app-header">
            <h1>ğŸ° MOAT Analyzer</h1>
            <p class="subtitle">Competitive Moat & AI Disruption Risk</p>
          </header>

          <nav class="tab-bar">
            <button class="tab ${activeTab==='analyze'?'active':''}"
              onClick=${()=>{setActiveTab('analyze');setSelected(null);}}>Analyze</button>
            <button class="tab ${activeTab==='sectors'?'active':''}"
              onClick=${()=>{setActiveTab('sectors');setSelectedSector(null);}}>Sectors</button>
            <button class="tab ${activeTab==='charts'?'active':''}"
              onClick=${()=>setActiveTab('charts')}>Charts</button>
            <button class="tab ${activeTab==='wiki'?'active':''}"
              onClick=${()=>setActiveTab('wiki')}>Wiki</button>
            <button class="tab ${activeTab==='settings'?'active':''}"
              onClick=${()=>setActiveTab('settings')}>âš™</button>
          </nav>

          <main class="content">

            ${activeTab==='analyze' && html`<div>
              <div class="analyze-controls">
                <div class="mode-toggle">
                  <button class="mode-btn${mode==='single'?' active':''}" onClick=${()=>setMode("single")}>Single</button>
                  <button class="mode-btn${mode==='portfolio'?' active':''}" onClick=${()=>setMode("portfolio")}>Portfolio</button>
                </div>
                ${mode==="single"?html`
                  <div class="input-row">
                    <input class="input-field" placeholder="AAPL" value=${ticker}
                      onInput=${e=>setTicker(e.target.value)}
                      onKeyDown=${e=>{if(e.key==="Enter")handleAnalyze();}} />
                    <button class="btn btn-primary" onClick=${handleAnalyze}
                      disabled=${loading||!ticker.trim()}>${loading?"Analyzingâ€¦":"Analyze"}</button>
                  </div>`
                :html`
                  <div class="input-row">
                    <input class="input-field" placeholder="AAPL, MSFT, GOOGL" value=${tickerList}
                      onInput=${e=>setTickerList(e.target.value)}
                      onKeyDown=${e=>{if(e.key==="Enter")handleAnalyze();}} style="font-size:0.78rem" />
                  </div>
                  <div class="input-row">
                    <button class="btn btn-primary" onClick=${handleAnalyze}
                      disabled=${loading||!tickerList.trim()} style="flex:1">${loading?(progress||"â€¦"):"Analyze Portfolio"}</button>
                    <input type="file" ref=${fileRef} accept=".csv,.tsv,.txt" onChange=${handleFileUpload} style="display:none" />
                    <button class="btn btn-secondary" onClick=${()=>fileRef.current?.click()}>ğŸ“ CSV</button>
                  </div>`}
                ${loading && html`<div style="color:${C.accent};font-size:0.78rem;margin-top:6px">${progress}</div>`}
                ${error && html`<div style="color:${C.red};font-size:0.78rem;margin-top:6px">${error}</div>`}
              </div>

              ${r && (mode==="single"||selected) && html`<${TickerDetail} r=${r}
                onBack=${selected?()=>{setSelected(null);}:null}
                detailTab=${detailTab} setDetailTab=${setDetailTab} />`}

              ${portfolio.length>0 && !selected && html`<${PortfolioView}
                portfolio=${portfolio}
                onSelect=${d=>{setSelected(d);setDetailTab(0);}}
                portTab=${portTab} setPortTab=${setPortTab} />`}

              ${!r && !selected && portfolio.length===0 && !loading && html`
                <div class="placeholder">
                  <p>Enter a ticker above to analyze</p>
                  <p class="dim" style="margin-top:4px;font-size:0.78rem">Fetches live financials from Yahoo + FMP. Add AI key in âš™ for moat scoring.</p>
                  <p class="dim" style="margin-top:12px;font-size:0.7rem">Try: AAPL, MSFT, ADBE, V, WU, NVDA, ACN</p>
                </div>`}
            </div>`}

            ${activeTab==='sectors' && !selectedSector && html`
              <${SummaryPills} sorted=${sorted} subCount=${subCount} />
              <div class="sector-list">
                ${sorted.map(([sector,data]) => html`
                  <${SectorCard} key=${sector} sector=${sector} data=${data}
                    onClick=${()=>setSelectedSector(sector)} />`)}
              </div>`}

            ${activeTab==='sectors' && selectedSector && html`
              <${SectorDetail} sector=${selectedSector} data=${sComp[selectedSector]}
                raw=${SECTOR_DB[selectedSector]} onBack=${()=>setSelectedSector(null)} />`}

            ${activeTab==='charts' && html`
              <div class="charts-view">
                <div class="chart-card">
                  <h3 class="chart-title">Moat vs AI Risk by Sector</h3>
                  <p class="chart-sub">Blue = moat strength, orange = AI disruption risk</p>
                  <${GroupedBarChart} data=${[...chartData].reverse()}
                    onClick=${(name)=>{setActiveTab('sectors');setSelectedSector(name);}} />
                </div>
                <div class="chart-card">
                  <h3 class="chart-title">Net Moat Score</h3>
                  <p class="chart-sub">Moat minus AI risk â€” green = protected, red = vulnerable</p>
                  <${VBarChart} data=${chartData}
                    onClick=${(name)=>{setActiveTab('sectors');setSelectedSector(name);}} />
                </div>
                <div class="chart-card">
                  <h3 class="chart-title">Sector Risk Map</h3>
                  <p class="chart-sub">Moat strength vs AI disruption risk</p>
                  <${ScatterPlot} data=${scatterData} />
                </div>
              </div>`}

            ${activeTab==='wiki' && html`<${WikiTab} />`}

            ${activeTab==='settings' && html`
              <div style="padding-top:8px">
                <div class="detail-section">
                  <div class="section-title">FMP API Key</div>
                  <p class="dim" style="font-size:0.72rem;margin-bottom:6px">financialmodelingprep.com â€” 250 calls/day free. Optional fallback for Yahoo.</p>
                  <input class="input-field" type="password" placeholder="FMP API key"
                    value=${fmpKey} onInput=${e=>setFmpKey(e.target.value)} />
                </div>
                <div class="detail-section">
                  <div class="section-title">AI Provider</div>
                  <select class="input-field" value=${llmProvider}
                    onChange=${e=>{setLlmProvider(e.target.value);setLlmKey("");}}>
                    ${Object.entries(LLM_PROVIDERS).map(([k,v])=>html`<option value=${k}>${v.name}</option>`)}
                  </select>
                </div>
                <div class="detail-section">
                  <div class="section-title">${LLM_PROVIDERS[llmProvider]?.name||"LLM"} API Key</div>
                  <p class="dim" style="font-size:0.72rem;margin-bottom:6px">${LLM_PROVIDERS[llmProvider]?.help||"Enter API key"}. Without it, sector defaults are used.</p>
                  <input class="input-field" type="password" placeholder=${LLM_PROVIDERS[llmProvider]?.placeholder||"API key"}
                    value=${llmKey} onInput=${e=>setLlmKey(e.target.value)} />
                </div>
                <div class="detail-section">
                  <div class="section-title">PM Score Overrides</div>
                  <p class="dim" style="font-size:0.72rem;margin-bottom:8px">Override sector-level moat/AI scores. Changes persist and feed into all sector calculations.</p>
                  <${OverrideEditor} overrides=${overrides} onSave=${o=>{setOverrides(o);saveOverrides(o);}} />
                </div>
                <div class="detail-section">
                  <div class="section-title">PM Notes</div>
                  <p class="dim" style="font-size:0.72rem;margin-bottom:8px">Add commentary per ticker. Stored locally.</p>
                  <${NotesEditor} />
                </div>
                <div class="detail-section">
                  <div class="section-title">Export</div>
                  <div style="display:flex;flex-direction:column;gap:8px">
                    ${portfolio.length>0&&html`<button class="btn btn-secondary" onClick=${()=>exportPortfolio(portfolio)}>ğŸ“‹ Copy Portfolio (TSV)</button>`}
                    ${r&&html`<button class="btn btn-secondary" onClick=${()=>exportTicker(r)}>ğŸ“‹ Copy Ticker Detail</button>`}
                    <button class="btn btn-secondary" onClick=${()=>exportOverrides(overrides)}>ğŸ“‹ Copy Overrides (JSON)</button>
                    <button class="btn btn-secondary" style="color:${C.red}" onClick=${()=>{if(confirm("Reset all overrides and notes?")){setOverrides({sectors:{},tickers:{}});saveOverrides({sectors:{},tickers:{}});localStorage.removeItem("moat_pm_notes");}}}>ğŸ—‘ Reset All Data</button>
                  </div>
                </div>
              </div>`}
          </main>

          <footer class="app-footer">
            <span class="dim">MOAT Analyzer v5.0 â€” iOS PWA Â· Adrian Helfert</span>
          </footer>
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MOUNT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    render(html`<${App} />`, document.getElementById('app'));
  </script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 15px; -webkit-text-size-adjust: 100%; -webkit-font-smoothing: antialiased; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      background: #0a0f1a; color: #e2e8f0;
      min-height: 100vh; min-height: -webkit-fill-available;
      overflow-x: hidden;
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .app { max-width: 100%; min-height: 100vh; display: flex; flex-direction: column; }
    .app-header { padding: 20px 16px 12px; text-align: center; border-bottom: 1px solid #1e2d3d; }
    .app-header h1 { font-size: 1.4rem; font-weight: 700; letter-spacing: -0.02em; }
    .subtitle { font-size: 0.8rem; color: #8899aa; margin-top: 2px; }

    .tab-bar {
      display: flex; padding: 8px 8px; border-bottom: 1px solid #1e2d3d;
      background: #111827; position: sticky; top: 0; z-index: 100;
    }
    .tab {
      flex: 1; padding: 10px 0; background: transparent; border: none;
      color: #8899aa; font-size: 0.78rem; font-weight: 600;
      cursor: pointer; border-radius: 8px; transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .tab.active { background: #1a2332; color: #4da3ff; }
    .content { flex: 1; padding: 12px 12px 80px; }

    /* Summary Pills */
    .summary-pills { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 12px; }
    .sum-pill { background: #111827; border-radius: 8px; padding: 8px 6px; text-align: center; }
    .sum-label { display: block; font-size: 0.6rem; color: #8899aa; text-transform: uppercase; letter-spacing: 0.05em; }
    .sum-val { display: block; font-size: 0.95rem; font-weight: 700; margin-top: 2px; }

    /* Sector Cards */
    .sector-list { display: flex; flex-direction: column; gap: 8px; }
    .sector-card {
      background: #111827; border-radius: 10px; padding: 12px 14px;
      cursor: pointer; transition: transform 0.15s, background 0.15s;
      -webkit-tap-highlight-color: transparent; position: relative;
    }
    .sector-card:active { transform: scale(0.98); background: #1a2332; }
    .sector-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .sector-name { font-size: 0.9rem; font-weight: 600; }
    .tier-badge { font-size: 0.65rem; font-weight: 700; padding: 2px 8px; border-radius: 4px; letter-spacing: 0.05em; }
    .sector-scores { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
    .score-item { text-align: center; }
    .score-label { display: block; font-size: 0.65rem; color: #8899aa; text-transform: uppercase; letter-spacing: 0.05em; }
    .score-value { display: block; font-size: 1rem; font-weight: 700; font-variant-numeric: tabular-nums; }
    .card-sub-count { font-size: 0.7rem; color: #4da3ff; margin-top: 6px; text-align: right; }

    /* Charts */
    .chart-svg { display: block; width: 100%; height: auto; max-width: 100%; }
    .radar-chart { max-width: 200px; margin: 0 auto; }
    .charts-view { display: flex; flex-direction: column; gap: 14px; }
    .chart-card { background: #111827; border-radius: 12px; padding: 16px 12px; }
    .chart-title { font-size: 0.9rem; font-weight: 700; color: #4da3ff; margin-bottom: 4px; }
    .chart-sub { font-size: 0.7rem; color: #8899aa; margin-bottom: 12px; }

    /* Sector Detail */
    .sector-detail { padding-bottom: 24px; }
    .back-btn {
      background: none; border: none; color: #4da3ff; font-size: 0.95rem;
      font-weight: 600; font-family: inherit; padding: 8px 0 16px;
      cursor: pointer; -webkit-tap-highlight-color: transparent;
    }
    .detail-header { background: #0f1929; border-radius: 12px; padding: 16px 18px; margin-bottom: 16px; }
    .detail-title-row { display: flex; justify-content: space-between; align-items: center; }
    .detail-title { font-size: 1.25rem; font-weight: 700; color: #e2e8f0; }
    .tier-badge-lg { font-size: 0.75rem; font-weight: 700; padding: 4px 12px; border-radius: 8px; letter-spacing: 0.05em; }
    .detail-net { font-size: 1.5rem; font-weight: 800; font-family: "SF Mono", ui-monospace, monospace; margin-top: 4px; }

    .score-pills { display: grid; grid-template-columns: repeat(auto-fit, minmax(85px, 1fr)); gap: 8px; margin-bottom: 20px; }
    .pill { background: #0f1929; border-radius: 10px; padding: 10px 8px; text-align: center; }
    .pill-label { display: block; font-size: 0.6rem; color: #8899aa; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px; }
    .pill-value { display: block; font-size: 1rem; font-weight: 700; font-family: "SF Mono", ui-monospace, monospace; color: #e2e8f0; }

    .radar-pair { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .radar-col { text-align: center; }
    .radar-label { font-size: 0.65rem; color: #8899aa; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 6px; }

    .detail-section { background: #0f1929; border-radius: 12px; padding: 16px; margin-bottom: 14px; }
    .section-title { font-size: 0.85rem; font-weight: 700; color: #4da3ff; margin-bottom: 8px; }
    .section-sub { font-size: 0.75rem; color: #8899aa; margin-bottom: 10px; }

    .factor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .factor-item { display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: #0a0f1a; border-radius: 8px; }
    .factor-abbr { font-size: 0.7rem; font-weight: 700; color: #8899aa; width: 28px; text-align: center; flex-shrink: 0; }
    .factor-name { font-size: 0.75rem; color: #c8d6e5; flex: 1; }
    .factor-score { font-size: 0.85rem; font-weight: 700; font-family: "SF Mono", ui-monospace, monospace; flex-shrink: 0; }

    /* Subsector Cards */
    .sub-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .sub-card {
      background: #111827; border-radius: 10px; padding: 14px;
      margin-bottom: 10px;
    }
    .sub-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .sub-card-name { font-size: 0.85rem; font-weight: 700; color: #e2e8f0; }
    .sub-card-net { font-size: 1.1rem; font-weight: 800; font-family: "SF Mono", ui-monospace, monospace; }
    .sub-card-examples { font-size: 0.7rem; color: #8899aa; margin-bottom: 10px; }
    .sub-card-footer { display: flex; justify-content: space-between; font-size: 0.75rem; }

    /* Tables */
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .data-table th { text-align: left; padding: 8px 6px; color: #8899aa; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #1e2d3d; }
    .data-table td { padding: 8px 6px; border-bottom: 1px solid #1e2d3d10; font-variant-numeric: tabular-nums; }
    .sub-table td, .sub-table th { padding: 6px 4px; }

    /* Wiki */
    .wiki-content { padding-bottom: 40px; }
    .wiki-h1 { font-size: 1.3rem; font-weight: 700; margin-bottom: 4px; }
    .wiki-sub { font-size: 0.8rem; color: #8899aa; margin-bottom: 16px; }
    .wiki-h2 { font-size: 1rem; font-weight: 700; color: #4da3ff; margin: 20px 0 8px; }
    .wiki-content p { font-size: 0.82rem; color: #c8d6e5; line-height: 1.5; margin-bottom: 8px; }
    .wiki-callout {
      background: #0f1929; border-left: 3px solid #4da3ff; border-radius: 8px;
      padding: 12px 14px; margin: 12px 0; font-size: 0.8rem; color: #c8d6e5; line-height: 1.5;
    }
    .wiki-formula {
      background: #0f1929; border-radius: 8px; padding: 10px 14px; margin: 8px 0 12px;
      font-family: "SF Mono", ui-monospace, monospace; font-size: 0.75rem; color: #4da3ff;
      overflow-x: auto; white-space: nowrap;
    }
    .wiki-table { margin: 8px 0 16px; }
    .wiki-table th { color: #4da3ff; }
    .wiki-table td { font-size: 0.78rem; }
    .wiki-footer { font-size: 0.7rem; color: #8899aa60; margin-top: 24px; text-align: center; }

    /* Forms & Inputs */
    .input-field { background: #1a2332; border: 1px solid #1e2d3d; border-radius: 8px; padding: 10px 12px; color: #e2e8f0; font-size: 0.9rem; width: 100%; outline: none; -webkit-appearance: none; }
    .input-field:focus { border-color: #4da3ff; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; font-size: 0.85rem; cursor: pointer; -webkit-tap-highlight-color: transparent; transition: opacity 0.15s; }
    .btn:active { opacity: 0.8; }
    .btn-primary { background: #4da3ff; color: #0a0f1a; }
    .btn-secondary { background: #1a2332; color: #e2e8f0; border: 1px solid #1e2d3d; }

    /* Analyze Controls */
    .analyze-controls { margin-bottom: 16px; }
    .mode-toggle { display: flex; gap: 6px; margin-bottom: 10px; }
    .mode-btn { flex: 1; padding: 8px; background: #111827; border: 1px solid #1e2d3d; border-radius: 8px; color: #8899aa; font-size: 0.82rem; font-weight: 600; cursor: pointer; -webkit-tap-highlight-color: transparent; font-family: inherit; }
    .mode-btn.active { background: #4da3ff18; border-color: #4da3ff; color: #4da3ff; }
    .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .input-row .input-field { flex: 1; }
    .input-row .btn { white-space: nowrap; }
    select.input-field { -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238899aa' d='M3 5l3 3 3-3'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }

    /* Ticker Detail */
    .ticker-detail { padding-top: 4px; }
    .ticker-header { padding: 12px 0; border-bottom: 1px solid #1e2d3d; margin-bottom: 8px; }
    .ticker-top-row { display: flex; align-items: baseline; gap: 8px; flex-wrap: wrap; }
    .ticker-symbol { font-family: "SF Mono", ui-monospace, monospace; font-size: 1.6rem; font-weight: 800; color: #4da3ff; }
    .ticker-name { font-size: 0.95rem; font-weight: 600; color: #e2e8f0; }
    .tag-row { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; align-items: center; }

    /* Analysis Pills */
    .a-pill { display: flex; flex-direction: column; align-items: center; background: #0f1929; border-radius: 8px; padding: 8px 6px; min-width: 60px; flex: 1; }
    .a-pill-label { font-size: 0.58rem; color: #8899aa; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
    .a-pill-value { font-size: 1rem; font-weight: 800; margin-top: 2px; font-family: "SF Mono", ui-monospace, monospace; }
    .a-pill-unit { font-size: 0.65rem; }
    .a-tag { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 0.68rem; font-weight: 700; border: 1px solid; }
    .a-badge { padding: 3px 10px; border-radius: 14px; font-size: 0.65rem; font-weight: 700; letter-spacing: 0.05em; }
    .a-badge.big { padding: 5px 14px; font-size: 0.75rem; }

    /* Score Bars */
    .a-sb { display: flex; align-items: center; gap: 8px; padding: 5px 0; border-bottom: 1px solid #1e2d3d; }
    .a-sb-num { width: 26px; height: 26px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.82rem; flex-shrink: 0; }
    .a-sb-label { flex: 1; font-size: 0.78rem; font-weight: 600; color: #e2e8f0; }
    .a-sb-bar { width: 50px; height: 5px; background: #0a0f1a; border-radius: 3px; overflow: hidden; flex-shrink: 0; border: 1px solid #1e2d3d; }
    .a-sb-fill { height: 100%; border-radius: 3px; }

    /* Info Rows */
    .a-ir { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #1e2d3d; font-size: 0.8rem; }

    /* Detail Tabs */
    .detail-tabs { display: flex; border-bottom: 1px solid #1e2d3d; margin: 8px 0; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .dtab { flex-shrink: 0; padding: 8px 14px; background: transparent; border: none; color: #8899aa; font-size: 0.72rem; font-weight: 600; cursor: pointer; border-radius: 6px 6px 0 0; -webkit-tap-highlight-color: transparent; font-family: inherit; white-space: nowrap; }
    .dtab.active { color: #4da3ff; border-bottom: 2px solid #4da3ff; }
    .detail-pane { padding-top: 12px; }

    /* Status bar */
    .status-bar { padding: 10px 12px; border-radius: 8px; margin: 8px 0; font-size: 0.75rem; word-break: break-all; }
    .status-bar.ok { background: #43b02a18; border: 1px solid #43b02a44; }
    .status-bar.warn { background: #f39c1218; border: 1px solid #f39c1244; }
    .status-items { display: flex; flex-direction: column; gap: 4px; }
    .status-note { margin-top: 6px; font-size: 0.7rem; color: #f39c12; }

    /* Moat Ladder */
    .ladder-rung { display: flex; align-items: center; gap: 8px; padding: 8px 12px; margin-bottom: 4px; border-radius: 8px; border: 1px solid #1e2d3d; }
    .ladder-rung.active { font-weight: 700; }
    .ladder-num { width: 24px; height: 24px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 0.72rem; font-weight: 800; color: #fff; flex-shrink: 0; }

    /* Big Metrics */
    .big-metric { background: #0a0f1a; border-radius: 8px; padding: 10px; text-align: center; border: 1px solid #1e2d3d; }
    .big-metric-label { font-size: 0.6rem; color: #8899aa; text-transform: uppercase; letter-spacing: 0.05em; }
    .big-metric-val { font-size: 1.4rem; font-weight: 800; font-family: "SF Mono", ui-monospace, monospace; margin-top: 2px; }

    /* Portfolio rows */
    .port-row { cursor: pointer; -webkit-tap-highlight-color: transparent; }
    .port-row:active { background: #1a2332; }

    /* Override Editor */
    .override-sector-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #0a0f1a; border-radius: 8px; margin-bottom: 4px; cursor: pointer; -webkit-tap-highlight-color: transparent; border: 1px solid #1e2d3d; }
    .override-sector-row:active { background: #1a2332; }
    .override-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #1e2d3d; }
    .override-label { font-size: 0.78rem; font-weight: 600; flex: 1; }
    .override-btns { display: flex; gap: 4px; }
    .score-btn { width: 30px; height: 30px; border-radius: 6px; border: 1px solid #1e2d3d; background: transparent; color: #8899aa; font-weight: 700; font-size: 0.82rem; cursor: pointer; -webkit-tap-highlight-color: transparent; font-family: inherit; }
    .score-btn.active { font-weight: 800; }

    /* Notes Editor */
    .note-item { background: #0a0f1a; border-radius: 8px; padding: 10px 12px; margin-bottom: 6px; border: 1px solid #1e2d3d; }
    .note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .note-del { background: none; border: none; color: #e74c3c80; font-size: 0.9rem; cursor: pointer; padding: 2px 6px; -webkit-tap-highlight-color: transparent; }
    .note-text { width: 100%; background: #111827; border: 1px solid #1e2d3d; border-radius: 6px; color: #e2e8f0; font-size: 0.78rem; padding: 8px 10px; font-family: inherit; resize: vertical; outline: none; -webkit-appearance: none; }
    .note-text:focus { border-color: #4da3ff; }
    textarea.input-field { font-family: inherit; resize: vertical; }

    .placeholder { text-align: center; padding: 60px 20px; color: #8899aa; }
    .placeholder p:first-child { font-size: 1.2rem; margin-bottom: 8px; }
    .dim { color: #8899aa; }
    .app-footer { padding: 12px; text-align: center; font-size: 0.7rem; border-top: 1px solid #1e2d3d; }

    @supports (-webkit-touch-callout: none) { .tab-bar { padding-top: max(8px, env(safe-area-inset-top)); } }
    html { overflow: hidden; height: 100%; }
    body { overflow-y: auto; height: 100%; -webkit-overflow-scrolling: touch; }
  </style>
</head>
<body>
  <div id="app">
    <div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#8899aa">
      Loading MOAT Analyzer...
    </div>
  </div>
</body>
</html>
